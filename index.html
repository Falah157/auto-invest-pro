<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker</title>
    <style>
        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --accent-color: #FF8C00;
            --accent-light: #FFA500;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --success: #00aa00;
            --danger: #ff4444;
            --warning: #ffaa00;
            --border-color: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 20px;
            border-bottom: 2px solid var(--accent-color);
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--secondary-bg), var(--primary-bg));
            border-radius: 10px;
        }

        h1 {
            color: var(--accent-color);
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .bismillah {
            font-size: 1.5em;
            color: var(--accent-light);
            margin-top: 10px;
            font-weight: bold;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--secondary-bg);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .card-title {
            color: var(--accent-color);
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-box {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--accent-light);
            font-weight: bold;
        }

        .profit {
            color: var(--success);
        }

        .loss {
            color: var(--danger);
        }

        .tabs {
            display: flex;
            background-color: var(--secondary-bg);
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            margin-bottom: 0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background-color: var(--secondary-bg);
            color: var(--text-secondary);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .tab:hover {
            background-color: #2a2a2a;
        }

        .tab.active {
            background-color: var(--accent-color);
            color: var(--primary-bg);
        }

        .tab-content {
            display: none;
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: 0 0 10px 10px;
            border: 1px solid var(--border-color);
            border-top: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-primary);
            font-size: 1em;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .btn {
            background-color: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin-top: 10px;
            margin-right: 10px;
        }

        .btn:hover {
            background-color: var(--accent-light);
        }

        .btn-secondary {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: #444444;
        }

        .btn-warning {
            background-color: var(--warning);
            color: var(--primary-bg);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: var(--primary-bg);
            color: var(--accent-color);
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid var(--accent-color);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background-color: rgba(255, 140, 0, 0.1);
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .edit-btn {
            background-color: var(--accent-color);
            color: var(--primary-bg);
        }

        .delete-btn {
            background-color: var(--danger);
            color: white;
        }

        .dua-box {
            background: linear-gradient(135deg, var(--primary-bg), #1a0a00);
            border-left: 4px solid var(--accent-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-style: italic;
        }

        .arabic {
            font-size: 1.2em;
            text-align: right;
            direction: rtl;
            margin-bottom: 10px;
            color: var(--accent-light);
        }

        .translation {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            display: none;
        }

        .alert.success {
            background-color: rgba(0, 170, 0, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert.error {
            background-color: rgba(255, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--secondary-bg);
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        .ingredient-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .ingredient-row select {
            flex: 2;
        }

        .ingredient-row input {
            flex: 1;
        }

        .remove-row {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-radius: 0;
            }
            
            .ingredient-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçåü•• Islamic Food Business Tracker</h1>
            <div class="subtitle">Track your halal business with barakah</div>
            <div class="bismillah">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸíŸÖŸê</div>
        </header>

        <div class="dua-box">
            <div class="arabic">ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿ®Ÿéÿßÿ±ŸêŸÉŸí ŸÑŸêŸä ŸÅŸêŸäŸÖŸéÿß ÿ±Ÿéÿ≤ŸéŸÇŸíÿ™ŸéŸÜŸêŸä</div>
            <div class="translation">"O Allah, bless me in what You have provided me."</div>
        </div>

        <div id="alert" class="alert"></div>

        <div class="dashboard">
            <div class="card">
                <h3 class="card-title">üìä Today's Summary</h3>
                <div class="stat-box">
                    <span class="stat-label">Total Items Made:</span>
                    <span class="stat-value" id="totalMade">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Total Items Sold:</span>
                    <span class="stat-value" id="totalSold">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Total Revenue:</span>
                    <span class="stat-value" id="totalRevenue">0 MVR</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Total Profit:</span>
                    <span class="stat-value profit" id="totalProfit">0 MVR</span>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üí∞ Weekly Stats</h3>
                <div class="stat-box">
                    <span class="stat-label">Week Profit:</span>
                    <span class="stat-value profit" id="weekProfit">0 MVR</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Best Seller:</span>
                    <span class="stat-value" id="bestSeller">-</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Profit Margin:</span>
                    <span class="stat-value" id="profitMargin">0%</span>
                </div>
                <button class="btn" onclick="viewReport()">üìà View Full Report</button>
            </div>

            <div class="card">
                <h3 class="card-title">üì¶ Inventory Status</h3>
                <div id="inventoryList">
                    <div class="stat-box">
                        <span class="stat-label">Loading...</span>
                        <span class="stat-value">...</span>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="showTab('inventory')">Manage Inventory</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('ingredients')">üõí Ingredients</button>
            <button class="tab" onclick="showTab('recipes')">üçΩÔ∏è Recipes</button>
            <button class="tab" onclick="showTab('sales')">üí∞ Daily Sales</button>
            <button class="tab" onclick="showTab('inventory')">üì¶ Inventory</button>
            <button class="tab" onclick="showTab('reports')">üìä Reports</button>
        </div>

        <!-- INGREDIENTS TAB -->
        <div id="ingredients" class="tab-content active">
            <h2 class="card-title">Manage Ingredients</h2>
            <button class="btn" onclick="openIngredientModal()">‚ûï Add New Ingredient</button>
            
            <div class="table-container">
                <h3 class="card-title">Ingredient List</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Current Stock</th>
                            <th>Unit</th>
                            <th>Cost/Unit</th>
                            <th>Total Value</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ingredientTable">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- RECIPES TAB -->
        <div id="recipes" class="tab-content">
            <h2 class="card-title">Manage Recipes</h2>
            <button class="btn" onclick="openRecipeModal()">‚ûï Add New Recipe</button>
            
            <div class="table-container">
                <h3 class="card-title">Recipe List</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Recipe</th>
                            <th>Cost/Piece</th>
                            <th>Sell Price</th>
                            <th>Profit/Piece</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recipeTable">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SALES TAB -->
        <div id="sales" class="tab-content">
            <h2 class="card-title">Daily Sales Tracking</h2>
            <button class="btn" onclick="openSalesModal()">‚ûï Add Sales Entry</button>
            
            <div class="table-container">
                <h3 class="card-title">Sales History</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Item</th>
                            <th>Made</th>
                            <th>Sold</th>
                            <th>Cost</th>
                            <th>Revenue</th>
                            <th>Profit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salesTable">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- INVENTORY TAB -->
        <div id="inventory" class="tab-content">
            <h2 class="card-title">Inventory Management</h2>
            <button class="btn" onclick="generateShoppingList()">üõçÔ∏è Generate Shopping List</button>
            <button class="btn btn-secondary" onclick="openRestockModal()">üì¶ Restock Ingredients</button>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ingredient</th>
                            <th>Current Stock</th>
                            <th>Used Today</th>
                            <th>Remaining</th>
                            <th>Status</th>
                            <th>Reorder Level</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <div id="shoppingList" class="card" style="display: none; margin-top: 20px;">
                <h3 class="card-title">üõí Shopping List</h3>
                <div id="shoppingItems"></div>
            </div>
        </div>

        <!-- REPORTS TAB -->
        <div id="reports" class="tab-content">
            <h2 class="card-title">Business Reports</h2>
            
            <div class="card">
                <h3 class="card-title">üìÖ Daily Report</h3>
                <div id="dailyReport"></div>
                <button class="btn" onclick="generateDailyReport()">Generate Daily Report</button>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3 class="card-title">üìÜ Weekly Report</h3>
                <div id="weeklyReport"></div>
                <button class="btn" onclick="generateWeeklyReport()">Generate Weekly Report</button>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3 class="card-title">üìà Monthly Report</h3>
                <div id="monthlyReport"></div>
                <button class="btn" onclick="generateMonthlyReport()">Generate Monthly Report</button>
            </div>
            
            <button class="btn btn-warning" onclick="exportAllData()" style="margin-top: 20px;">üì• Export All Data</button>
            <button class="btn btn-danger" onclick="confirmResetData()" style="margin-top: 20px;">üóëÔ∏è Reset All Data</button>
        </div>

        <div class="dua-box" style="margin-top: 40px;">
            <div class="arabic">ÿ±Ÿéÿ®ŸêŸë ÿ≤ŸêÿØŸíŸÜŸêŸä ÿπŸêŸÑŸíŸÖŸãÿß ŸàŸéÿßÿ±Ÿíÿ≤ŸèŸÇŸíŸÜŸêŸä ŸÅŸéŸáŸíŸÖŸãÿß</div>
            <div class="translation">"My Lord, increase me in knowledge and grant me understanding."</div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="ingredientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="ingredientModalTitle">Add New Ingredient</h2>
                <button class="close-modal" onclick="closeIngredientModal()">&times;</button>
            </div>
            <form id="ingredientForm">
                <input type="hidden" id="ingredientId">
                <div class="form-group">
                    <label for="ingredientName">Ingredient Name:</label>
                    <input type="text" id="ingredientName" required>
                </div>
                <div class="form-group">
                    <label for="quantity">Initial Quantity:</label>
                    <input type="number" id="quantity" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="unit">Unit:</label>
                    <select id="unit" required>
                        <option value="piece">Piece</option>
                        <option value="gram">Gram (g)</option>
                        <option value="kg">Kilogram (kg)</option>
                        <option value="ml">Milliliter (ml)</option>
                        <option value="liter">Liter (L)</option>
                        <option value="pack">Pack</option>
                        <option value="bunch">Bunch</option>
                        <option value="bottle">Bottle</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="purchasePrice">Purchase Price (MVR):</label>
                    <input type="number" id="purchasePrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="reorderLevel">Reorder Level (% of stock):</label>
                    <input type="number" id="reorderLevel" step="1" value="20" required>
                    <small>When stock falls below this percentage, it will appear in shopping list</small>
                </div>
                <button type="submit" class="btn">üíæ Save Ingredient</button>
                <button type="button" class="btn btn-secondary" onclick="closeIngredientModal()">Cancel</button>
            </form>
        </div>
    </div>

    <div id="recipeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="recipeModalTitle">Add New Recipe</h2>
                <button class="close-modal" onclick="closeRecipeModal()">&times;</button>
            </div>
            <form id="recipeForm">
                <input type="hidden" id="recipeId">
                <div class="form-group">
                    <label for="recipeName">Recipe Name:</label>
                    <input type="text" id="recipeName" required>
                </div>
                <div class="form-group">
                    <label for="piecesMade">Pieces Made per Batch:</label>
                    <input type="number" id="piecesMade" required>
                </div>
                <div class="form-group">
                    <label for="sellingPrice">Selling Price per Piece (MVR):</label>
                    <input type="number" id="sellingPrice" step="0.01" required>
                </div>
                
                <h3 class="card-title">Ingredients for this Recipe</h3>
                <div id="recipeIngredientsContainer">
                    <div class="ingredient-row">
                        <select class="ingredient-select" required>
                            <option value="">Select Ingredient</option>
                        </select>
                        <input type="number" class="ingredient-qty" placeholder="Quantity" step="0.01" required>
                        <button type="button" class="remove-row" onclick="this.parentElement.remove()">Remove</button>
                    </div>
                </div>
                
                <button type="button" class="btn btn-secondary" onclick="addIngredientRow()">‚ûï Add More Ingredients</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="recipeNotes">Notes (Optional):</label>
                    <textarea id="recipeNotes" rows="3"></textarea>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background-color: var(--primary-bg); border-radius: 5px;">
                    <h4>Recipe Cost Preview:</h4>
                    <div id="recipeCostPreview">Add ingredients to see cost calculation</div>
                </div>
                
                <button type="submit" class="btn" style="margin-top: 20px;">üíæ Save Recipe</button>
                <button type="button" class="btn btn-secondary" onclick="closeRecipeModal()">Cancel</button>
            </form>
        </div>
    </div>

    <div id="salesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="salesModalTitle">Add Sales Entry</h2>
                <button class="close-modal" onclick="closeSalesModal()">&times;</button>
            </div>
            <form id="salesForm">
                <input type="hidden" id="salesId">
                <div class="form-group">
                    <label for="salesDate">Date:</label>
                    <input type="date" id="salesDate" required>
                </div>
                <div class="form-group">
                    <label for="salesRecipe">Select Recipe:</label>
                    <select id="salesRecipe" required>
                        <option value="">Select Recipe</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="piecesMadeToday">Pieces Made Today:</label>
                    <input type="number" id="piecesMadeToday" required>
                </div>
                <div class="form-group">
                    <label for="piecesSoldToday">Pieces Sold Today:</label>
                    <input type="number" id="piecesSoldToday" required>
                </div>
                <div class="form-group">
                    <label for="salesNotes">Notes (Optional):</label>
                    <textarea id="salesNotes" rows="3"></textarea>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background-color: var(--primary-bg); border-radius: 5px;">
                    <h4>Profit Preview:</h4>
                    <div id="profitPreview">Select recipe and enter quantities</div>
                </div>
                
                <button type="submit" class="btn">üíæ Save Sales Entry</button>
                <button type="button" class="btn btn-secondary" onclick="closeSalesModal()">Cancel</button>
            </form>
        </div>
    </div>

    <div id="restockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Restock Ingredients</h2>
                <button class="close-modal" onclick="closeRestockModal()">&times;</button>
            </div>
            <form id="restockForm">
                <div class="form-group">
                    <label for="restockIngredient">Select Ingredient to Restock:</label>
                    <select id="restockIngredient" required>
                        <option value="">Select Ingredient</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="restockQuantity">Quantity to Add:</label>
                    <input type="number" id="restockQuantity" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="restockPrice">New Purchase Price (MVR, Optional):</label>
                    <input type="number" id="restockPrice" step="0.01">
                    <small>Leave empty to keep current price</small>
                </div>
                <button type="submit" class="btn">üì¶ Restock</button>
                <button type="button" class="btn btn-secondary" onclick="closeRestockModal()">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        // ==================== DATA STORAGE ====================
        let ingredients = JSON.parse(localStorage.getItem('ingredients')) || [];
        let recipes = JSON.parse(localStorage.getItem('recipes')) || [];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];
        let settings = JSON.parse(localStorage.getItem('settings')) || { currency: 'MVR' };

        // ==================== INITIAL SAMPLE DATA ====================
        function initializeSampleData() {
            if (ingredients.length === 0) {
                ingredients = [
                    { 
                        id: 1, 
                        name: "Banana", 
                        quantity: 10, 
                        unit: "piece", 
                        purchasePrice: 50,
                        reorderLevel: 20
                    },
                    { 
                        id: 2, 
                        name: "Milk Chocolate", 
                        quantity: 200, 
                        unit: "gram", 
                        purchasePrice: 30,
                        reorderLevel: 20
                    },
                    { 
                        id: 3, 
                        name: "Peanuts", 
                        quantity: 100, 
                        unit: "gram", 
                        purchasePrice: 10,
                        reorderLevel: 20
                    },
                    { 
                        id: 4, 
                        name: "Desiccated Coconut", 
                        quantity: 500, 
                        unit: "gram", 
                        purchasePrice: 25,
                        reorderLevel: 20
                    },
                    { 
                        id: 5, 
                        name: "Condensed Milk", 
                        quantity: 200, 
                        unit: "ml", 
                        purchasePrice: 16,
                        reorderLevel: 20
                    },
                    { 
                        id: 6, 
                        name: "Cardamom Powder", 
                        quantity: 50, 
                        unit: "gram", 
                        purchasePrice: 20,
                        reorderLevel: 20
                    }
                ];
                saveIngredients();
            }

            if (recipes.length === 0) {
                recipes = [
                    {
                        id: 1,
                        name: "Chocolate Banana Bites",
                        piecesPerBatch: 10,
                        sellPrice: 8,
                        ingredients: [
                            { ingredientId: 1, quantity: 2 },
                            { ingredientId: 2, quantity: 100 },
                            { ingredientId: 3, quantity: 50 }
                        ],
                        notes: "Freeze for 2 hours before selling"
                    },
                    {
                        id: 2,
                        name: "Coconut Cardamom Balls",
                        piecesPerBatch: 10,
                        sellPrice: 6,
                        ingredients: [
                            { ingredientId: 4, quantity: 200 },
                            { ingredientId: 5, quantity: 100 },
                            { ingredientId: 6, quantity: 10 }
                        ],
                        notes: "Chill for 1 hour"
                    }
                ];
                saveRecipes();
            }
        }

        // ==================== SAVE FUNCTIONS ====================
        function saveIngredients() {
            localStorage.setItem('ingredients', JSON.stringify(ingredients));
        }

        function saveRecipes() {
            localStorage.setItem('recipes', JSON.stringify(recipes));
        }

        function saveSales() {
            localStorage.setItem('sales', JSON.stringify(sales));
        }

        function saveSettings() {
            localStorage.setItem('settings', JSON.stringify(settings));
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            updateDashboard();
        }

        function formatCurrency(amount) {
            return `${amount.toFixed(2)} ${settings.currency}`;
        }

        // ==================== INGREDIENTS MANAGEMENT ====================
        function openIngredientModal(ingredientId = null) {
            const modal = document.getElementById('ingredientModal');
            const title = document.getElementById('ingredientModalTitle');
            const form = document.getElementById('ingredientForm');
            
            if (ingredientId) {
                // Edit mode
                const ingredient = ingredients.find(i => i.id === ingredientId);
                if (ingredient) {
                    title.textContent = 'Edit Ingredient';
                    document.getElementById('ingredientId').value = ingredient.id;
                    document.getElementById('ingredientName').value = ingredient.name;
                    document.getElementById('quantity').value = ingredient.quantity;
                    document.getElementById('unit').value = ingredient.unit;
                    document.getElementById('purchasePrice').value = ingredient.purchasePrice;
                    document.getElementById('reorderLevel').value = ingredient.reorderLevel || 20;
                }
            } else {
                // Add mode
                title.textContent = 'Add New Ingredient';
                form.reset();
                document.getElementById('ingredientId').value = '';
            }
            
            modal.style.display = 'flex';
        }

        function closeIngredientModal() {
            document.getElementById('ingredientModal').style.display = 'none';
            document.getElementById('ingredientForm').reset();
        }

        document.getElementById('ingredientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const ingredientData = {
                id: document.getElementById('ingredientId').value || Date.now(),
                name: document.getElementById('ingredientName').value,
                quantity: parseFloat(document.getElementById('quantity').value),
                unit: document.getElementById('unit').value,
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
                reorderLevel: parseInt(document.getElementById('reorderLevel').value)
            };
            
            // Update or add
            const index = ingredients.findIndex(i => i.id == ingredientData.id);
            if (index > -1) {
                ingredients[index] = ingredientData;
                showAlert(`Ingredient "${ingredientData.name}" updated successfully!`);
            } else {
                ingredients.push(ingredientData);
                showAlert(`Ingredient "${ingredientData.name}" added successfully!`);
            }
            
            saveIngredients();
            closeIngredientModal();
            loadIngredientsTable();
            loadInventoryTable();
            updateDashboard();
        });

        function loadIngredientsTable() {
            const tbody = document.getElementById('ingredientTable');
            tbody.innerHTML = '';
            
            if (ingredients.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px;">No ingredients found. Add your first ingredient!</td></tr>`;
                return;
            }
            
            ingredients.forEach(ingredient => {
                const costPerUnit = ingredient.purchasePrice / ingredient.quantity;
                const totalValue = ingredient.purchasePrice;
                
                const row = `
                    <tr>
                        <td>${ingredient.name}</td>
                        <td>${ingredient.quantity} ${ingredient.unit}</td>
                        <td>${ingredient.unit}</td>
                        <td>${formatCurrency(costPerUnit)}</td>
                        <td>${formatCurrency(totalValue)}</td>
                        <td class="actions">
                            <button class="action-btn edit-btn" onclick="openIngredientModal(${ingredient.id})">‚úèÔ∏è Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteIngredient(${ingredient.id})">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function deleteIngredient(id) {
            if (confirm('Are you sure you want to delete this ingredient? This will affect all recipes using it.')) {
                // Check if ingredient is used in any recipe
                const usedInRecipes = recipes.filter(recipe => 
                    recipe.ingredients.some(ri => ri.ingredientId === id)
                );
                
                if (usedInRecipes.length > 0) {
                    const recipeNames = usedInRecipes.map(r => r.name).join(', ');
                    if (!confirm(`This ingredient is used in: ${recipeNames}. Delete anyway?`)) {
                        return;
                    }
                }
                
                ingredients = ingredients.filter(i => i.id !== id);
                saveIngredients();
                loadIngredientsTable();
                loadInventoryTable();
                updateDashboard();
                showAlert('Ingredient deleted successfully!');
            }
        }

        // ==================== RECIPES MANAGEMENT ====================
        function openRecipeModal(recipeId = null) {
            const modal = document.getElementById('recipeModal');
            const title = document.getElementById('recipeModalTitle');
            
            // Populate ingredient selects
            const selects = document.querySelectorAll('#recipeIngredientsContainer .ingredient-select');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Select Ingredient</option>';
                ingredients.forEach(ingredient => {
                    select.innerHTML += `<option value="${ingredient.id}">${ingredient.name} (${ingredient.unit})</option>`;
                });
            });
            
            if (recipeId) {
                // Edit mode
                const recipe = recipes.find(r => r.id === recipeId);
                if (recipe) {
                    title.textContent = 'Edit Recipe';
                    document.getElementById('recipeId').value = recipe.id;
                    document.getElementById('recipeName').value = recipe.name;
                    document.getElementById('piecesMade').value = recipe.piecesPerBatch;
                    document.getElementById('sellingPrice').value = recipe.sellPrice;
                    document.getElementById('recipeNotes').value = recipe.notes || '';
                    
                    // Clear existing rows and add recipe ingredients
                    const container = document.getElementById('recipeIngredientsContainer');
                    container.innerHTML = '';
                    
                    recipe.ingredients.forEach(ri => {
                        const ingredient = ingredients.find(i => i.id === ri.ingredientId);
                        if (ingredient) {
                            const row = document.createElement('div');
                            row.className = 'ingredient-row';
                            row.innerHTML = `
                                <select class="ingredient-select" required>
                                    <option value="">Select Ingredient</option>
                                    ${ingredients.map(i => `<option value="${i.id}" ${i.id === ri.ingredientId ? 'selected' : ''}>${i.name} (${i.unit})</option>`).join('')}
                                </select>
                                <input type="number" class="ingredient-qty" placeholder="Quantity" step="0.01" value="${ri.quantity}" required>
                                <button type="button" class="remove-row" onclick="this.parentElement.remove(); updateRecipeCostPreview()">Remove</button>
                            `;
                            container.appendChild(row);
                        }
                    });
                    
                    updateRecipeCostPreview();
                }
            } else {
                // Add mode
                title.textContent = 'Add New Recipe';
                document.getElementById('recipeForm').reset();
                document.getElementById('recipeId').value = '';
                
                // Reset to one empty row
                const container = document.getElementById('recipeIngredientsContainer');
                container.innerHTML = `
                    <div class="ingredient-row">
                        <select class="ingredient-select" required>
                            <option value="">Select Ingredient</option>
                            ${ingredients.map(i => `<option value="${i.id}">${i.name} (${i.unit})</option>`).join('')}
                        </select>
                        <input type="number" class="ingredient-qty" placeholder="Quantity" step="0.01" required>
                        <button type="button" class="remove-row" onclick="this.parentElement.remove(); updateRecipeCostPreview()">Remove</button>
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
        }

        function closeRecipeModal() {
            document.getElementById('recipeModal').style.display = 'none';
        }

        function addIngredientRow() {
            const container = document.getElementById('recipeIngredientsContainer');
            const row = document.createElement('div');
            row.className = 'ingredient-row';
            row.innerHTML = `
                <select class="ingredient-select" required>
                    <option value="">Select Ingredient</option>
                    ${ingredients.map(i => `<option value="${i.id}">${i.name} (${i.unit})</option>`).join('')}
                </select>
                <input type="number" class="ingredient-qty" placeholder="Quantity" step="0.01" required>
                <button type="button" class="remove-row" onclick="this.parentElement.remove(); updateRecipeCostPreview()">Remove</button>
            `;
            container.appendChild(row);
            
            // Add event listener to update cost preview
            row.querySelector('.ingredient-select').addEventListener('change', updateRecipeCostPreview);
            row.querySelector('.ingredient-qty').addEventListener('input', updateRecipeCostPreview);
        }

        function updateRecipeCostPreview() {
            let totalCost = 0;
            const rows = document.querySelectorAll('#recipeIngredientsContainer .ingredient-row');
            
            rows.forEach(row => {
                const select = row.querySelector('.ingredient-select');
                const qtyInput = row.querySelector('.ingredient-qty');
                
                if (select.value && qtyInput.value) {
                    const ingredient = ingredients.find(i => i.id == select.value);
                    if (ingredient) {
                        const costPerUnit = ingredient.purchasePrice / ingredient.quantity;
                        totalCost += costPerUnit * parseFloat(qtyInput.value);
                    }
                }
            });
            
            const piecesMade = parseInt(document.getElementById('piecesMade').value) || 1;
            const costPerPiece = totalCost / piecesMade;
            const sellPrice = parseFloat(document.getElementById('sellingPrice').value) || 0;
            const profitPerPiece = sellPrice - costPerPiece;
            
            document.getElementById('recipeCostPreview').innerHTML = `
                <div class="stat-box">
                    <span class="stat-label">Total Batch Cost:</span>
                    <span class="stat-value">${formatCurrency(totalCost)}</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Cost per Piece:</span>
                    <span class="stat-value">${formatCurrency(costPerPiece)}</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Profit per Piece:</span>
                    <span class="stat-value ${profitPerPiece >= 0 ? 'profit' : 'loss'}">${formatCurrency(profitPerPiece)}</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Profit Margin:</span>
                    <span class="stat-value ${profitPerPiece >= 0 ? 'profit' : 'loss'}">${costPerPiece > 0 ? ((profitPerPiece / costPerPiece) * 100).toFixed(1) : 0}%</span>
                </div>
            `;
        }

        document.getElementById('recipeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Collect ingredients
            const ingredientRows = document.querySelectorAll('#recipeIngredientsContainer .ingredient-row');
            const recipeIngredients = [];
            
            ingredientRows.forEach(row => {
                const select = row.querySelector('.ingredient-select');
                const qtyInput = row.querySelector('.ingredient-qty');
                
                if (select.value && qtyInput.value) {
                    recipeIngredients.push({
                        ingredientId: parseInt(select.value),
                        quantity: parseFloat(qtyInput.value)
                    });
                }
            });
            
            if (recipeIngredients.length === 0) {
                showAlert('Please add at least one ingredient!', 'error');
                return;
            }
            
            const recipeData = {
                id: document.getElementById('recipeId').value || Date.now(),
                name: document.getElementById('recipeName').value,
                piecesPerBatch: parseInt(document.getElementById('piecesMade').value),
                sellPrice: parseFloat(document.getElementById('sellingPrice').value),
                ingredients: recipeIngredients,
                notes: document.getElementById('recipeNotes').value
            };
            
            // Update or add
            const index = recipes.findIndex(r => r.id == recipeData.id);
            if (index > -1) {
                recipes[index] = recipeData;
                showAlert(`Recipe "${recipeData.name}" updated successfully!`);
            } else {
                recipes.push(recipeData);
                showAlert(`Recipe "${recipeData.name}" added successfully!`);
            }
            
            saveRecipes();
            closeRecipeModal();
            loadRecipesTable();
            updateDashboard();
        });

        function calculateRecipeCost(recipe) {
            let totalCost = 0;
            
            recipe.ingredients.forEach(recipeIngredient => {
                const ingredient = ingredients.find(i => i.id === recipeIngredient.ingredientId);
                if (ingredient) {
                    const costPerUnit = ingredient.purchasePrice / ingredient.quantity;
                    totalCost += costPerUnit * recipeIngredient.quantity;
                }
            });
            
            return totalCost;
        }

        function loadRecipesTable() {
            const tbody = document.getElementById('recipeTable');
            tbody.innerHTML = '';
            
            if (recipes.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px;">No recipes found. Add your first recipe!</td></tr>`;
                return;
            }
            
            recipes.forEach(recipe => {
                const totalCost = calculateRecipeCost(recipe);
                const costPerPiece = totalCost / recipe.piecesPerBatch;
                const profitPerPiece = recipe.sellPrice - costPerPiece;
                
                const row = `
                    <tr>
                        <td><strong>${recipe.name}</strong><br><small>${recipe.notes || ''}</small></td>
                        <td>${formatCurrency(costPerPiece)}</td>
                        <td>${formatCurrency(recipe.sellPrice)}</td>
                        <td class="${profitPerPiece >= 0 ? 'profit' : 'loss'}">${formatCurrency(profitPerPiece)}</td>
                        <td class="actions">
                            <button class="action-btn edit-btn" onclick="openRecipeModal(${recipe.id})">‚úèÔ∏è Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteRecipe(${recipe.id})">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function deleteRecipe(id) {
            if (confirm('Are you sure you want to delete this recipe?')) {
                // Check if recipe has sales
                const recipeSales = sales.filter(s => s.recipeId === id);
                if (recipeSales.length > 0) {
                    if (!confirm(`This recipe has ${recipeSales.length} sales records. Delete anyway?`)) {
                        return;
                    }
                }
                
                recipes = recipes.filter(r => r.id !== id);
                saveRecipes();
                loadRecipesTable();
                updateDashboard();
                showAlert('Recipe deleted successfully!');
            }
        }

        // ==================== SALES MANAGEMENT ====================
        function openSalesModal(salesId = null) {
            const modal = document.getElementById('salesModal');
            const title = document.getElementById('salesModalTitle');
            const recipeSelect = document.getElementById('salesRecipe');
            
            // Populate recipe select
            recipeSelect.innerHTML = '<option value="">Select Recipe</option>';
            recipes.forEach(recipe => {
                recipeSelect.innerHTML += `<option value="${recipe.id}">${recipe.name}</option>`;
            });
            
            // Set today's date as default
            document.getElementById('salesDate').value = new Date().toISOString().split('T')[0];
            
            if (salesId) {
                // Edit mode
                const sale = sales.find(s => s.id === salesId);
                if (sale) {
                    title.textContent = 'Edit Sales Entry';
                    document.getElementById('salesId').value = sale.id;
                    document.getElementById('salesDate').value = sale.date;
                    document.getElementById('salesRecipe').value = sale.recipeId;
                    document.getElementById('piecesMadeToday').value = sale.piecesMade;
                    document.getElementById('piecesSoldToday').value = sale.piecesSold;
                    document.getElementById('salesNotes').value = sale.notes || '';
                    
                    updateProfitPreview();
                }
            } else {
                // Add mode
                title.textContent = 'Add Sales Entry';
                document.getElementById('salesForm').reset();
                document.getElementById('salesId').value = '';
                document.getElementById('salesDate').value = new Date().toISOString().split('T')[0];
            }
            
            modal.style.display = 'flex';
        }

        function closeSalesModal() {
            document.getElementById('salesModal').style.display = 'none';
        }

        function updateProfitPreview() {
            const recipeId = parseInt(document.getElementById('salesRecipe').value);
            const piecesMade = parseInt(document.getElementById('piecesMadeToday').value) || 0;
            const piecesSold = parseInt(document.getElementById('piecesSoldToday').value) || 0;
            
            if (recipeId && piecesMade > 0) {
                const recipe = recipes.find(r => r.id === recipeId);
                if (recipe) {
                    const totalCost = calculateRecipeCost(recipe);
                    const costPerPiece = totalCost / recipe.piecesPerBatch;
                    const totalSaleCost = costPerPiece * piecesMade;
                    const revenue = recipe.sellPrice * piecesSold;
                    const profit = revenue - totalSaleCost;
                    
                    document.getElementById('profitPreview').innerHTML = `
                        <div class="stat-box">
                            <span class="stat-label">Total Cost:</span>
                            <span class="stat-value">${formatCurrency(totalSaleCost)}</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Revenue:</span>
                            <span class="stat-value">${formatCurrency(revenue)}</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Profit:</span>
                            <span class="stat-value ${profit >= 0 ? 'profit' : 'loss'}">${formatCurrency(profit)}</span>
                        </div>
                    `;
                }
            }
        }

        document.getElementById('salesForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const salesData = {
                id: document.getElementById('salesId').value || Date.now(),
                date: document.getElementById('salesDate').value,
                recipeId: parseInt(document.getElementById('salesRecipe').value),
                piecesMade: parseInt(document.getElementById('piecesMadeToday').value),
                piecesSold: parseInt(document.getElementById('piecesSoldToday').value),
                notes: document.getElementById('salesNotes').value
            };
            
            // Update or add
            const index = sales.findIndex(s => s.id == salesData.id);
            if (index > -1) {
                sales[index] = salesData;
                showAlert('Sales entry updated successfully!');
            } else {
                sales.push(salesData);
                showAlert('Sales entry added successfully!');
            }
            
            saveSales();
            closeSalesModal();
            loadSalesTable();
            loadInventoryTable();
            updateDashboard();
        });

        function loadSalesTable() {
            const tbody = document.getElementById('salesTable');
            tbody.innerHTML = '';
            
            if (sales.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px;">No sales records found. Add your first sales entry!</td></tr>`;
                return;
            }
            
            // Sort by date (newest first)
            const sortedSales = [...sales].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let totalRevenue = 0;
            let totalCost = 0;
            let totalProfit = 0;
            
            sortedSales.forEach(sale => {
                const recipe = recipes.find(r => r.id === sale.recipeId);
                if (recipe) {
                    const recipeCost = calculateRecipeCost(recipe);
                    const costPerPiece = recipeCost / recipe.piecesPerBatch;
                    const totalSaleCost = costPerPiece * sale.piecesMade;
                    const revenue = recipe.sellPrice * sale.piecesSold;
                    const profit = revenue - totalSaleCost;
                    
                    totalRevenue += revenue;
                    totalCost += totalSaleCost;
                    totalProfit += profit;
                    
                    const row = `
                        <tr>
                            <td>${sale.date}</td>
                            <td>${recipe.name}</td>
                            <td>${sale.piecesMade}</td>
                            <td>${sale.piecesSold}</td>
                            <td>${formatCurrency(totalSaleCost)}</td>
                            <td>${formatCurrency(revenue)}</td>
                            <td class="${profit >= 0 ? 'profit' : 'loss'}">${formatCurrency(profit)}</td>
                            <td class="actions">
                                <button class="action-btn edit-btn" onclick="openSalesModal(${sale.id})">‚úèÔ∏è Edit</button>
                                <button class="action-btn delete-btn" onclick="deleteSale(${sale.id})">üóëÔ∏è Delete</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            });
            
            // Add totals row
            tbody.innerHTML += `
                <tr style="font-weight: bold; background-color: rgba(255, 140, 0, 0.1);">
                    <td colspan="4">TOTAL</td>
                    <td>${formatCurrency(totalCost)}</td>
                    <td>${formatCurrency(totalRevenue)}</td>
                    <td class="${totalProfit >= 0 ? 'profit' : 'loss'}">${formatCurrency(totalProfit)}</td>
                    <td></td>
                </tr>
            `;
        }

        function deleteSale(id) {
            if (confirm('Are you sure you want to delete this sales record?')) {
                sales = sales.filter(s => s.id !== id);
                saveSales();
                loadSalesTable();
                loadInventoryTable();
                updateDashboard();
                showAlert('Sales record deleted!');
            }
        }

        // ==================== INVENTORY MANAGEMENT ====================
        function openRestockModal() {
            const modal = document.getElementById('restockModal');
            const select = document.getElementById('restockIngredient');
            
            select.innerHTML = '<option value="">Select Ingredient</option>';
            ingredients.forEach(ingredient => {
                select.innerHTML += `<option value="${ingredient.id}">${ingredient.name} (Current: ${ingredient.quantity} ${ingredient.unit})</option>`;
            });
            
            modal.style.display = 'flex';
        }

        function closeRestockModal() {
            document.getElementById('restockModal').style.display = 'none';
            document.getElementById('restockForm').reset();
        }

        document.getElementById('restockForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const ingredientId = parseInt(document.getElementById('restockIngredient').value);
            const addQuantity = parseFloat(document.getElementById('restockQuantity').value);
            const newPrice = document.getElementById('restockPrice').value;
            
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (ingredient) {
                ingredient.quantity += addQuantity;
                
                if (newPrice) {
                    ingredient.purchasePrice = parseFloat(newPrice);
                }
                
                saveIngredients();
                loadInventoryTable();
                loadIngredientsTable();
                updateDashboard();
                showAlert(`${addQuantity} ${ingredient.unit} of ${ingredient.name} added to stock!`);
                closeRestockModal();
            }
        });

        function loadInventoryTable() {
            const tbody = document.getElementById('inventoryTable');
            tbody.innerHTML = '';
            
            let inventoryListHTML = '';
            
            ingredients.forEach(ingredient => {
                // Calculate used today
                let usedToday = 0;
                const today = new Date().toISOString().split('T')[0];
                
                sales.forEach(sale => {
                    if (sale.date === today) {
                        const recipe = recipes.find(r => r.id === sale.recipeId);
                        if (recipe) {
                            const recipeIngredient = recipe.ingredients.find(ri => ri.ingredientId === ingredient.id);
                            if (recipeIngredient) {
                                const quantityPerPiece = recipeIngredient.quantity / recipe.piecesPerBatch;
                                usedToday += quantityPerPiece * sale.piecesMade;
                            }
                        }
                    }
                });
                
                const remaining = ingredient.quantity - usedToday;
                const reorderLevel = ingredient.reorderLevel || 20;
                const reorderAmount = (ingredient.quantity * reorderLevel / 100);
                const status = remaining <= 0 ? '‚ùå Out of Stock' : 
                              remaining <= reorderAmount ? '‚ö†Ô∏è Low Stock' : '‚úÖ In Stock';
                
                const row = `
                    <tr>
                        <td>${ingredient.name}</td>
                        <td>${ingredient.quantity.toFixed(2)} ${ingredient.unit}</td>
                        <td>${usedToday.toFixed(2)} ${ingredient.unit}</td>
                        <td>${remaining.toFixed(2)} ${ingredient.unit}</td>
                        <td>${status}</td>
                        <td>${reorderAmount.toFixed(1)} ${ingredient.unit}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
                
                // Update inventory list in dashboard
                inventoryListHTML += `
                    <div class="stat-box">
                        <span class="stat-label">${ingredient.name}:</span>
                        <span class="stat-value ${remaining <= reorderAmount ? 'loss' : ''}">${remaining.toFixed(1)} ${ingredient.unit}</span>
                    </div>
                `;
            });
            
            document.getElementById('inventoryList').innerHTML = inventoryListHTML || '<div class="stat-box"><span class="stat-label">No ingredients</span><span class="stat-value">-</span></div>';
        }

        function generateShoppingList() {
            const shoppingList = document.getElementById('shoppingList');
            const shoppingItems = document.getElementById('shoppingItems');
            shoppingItems.innerHTML = '';
            
            let listHTML = '<h4>Items to Restock:</h4>';
            let hasItems = false;
            
            ingredients.forEach(ingredient => {
                // Calculate used today
                let usedToday = 0;
                const today = new Date().toISOString().split('T')[0];
                
                sales.forEach(sale => {
                    if (sale.date === today) {
                        const recipe = recipes.find(r => r.id === sale.recipeId);
                        if (recipe) {
                            const recipeIngredient = recipe.ingredients.find(ri => ri.ingredientId === ingredient.id);
                            if (recipeIngredient) {
                                const quantityPerPiece = recipeIngredient.quantity / recipe.piecesPerBatch;
                                usedToday += quantityPerPiece * sale.piecesMade;
                            }
                        }
                    }
                });
                
                const remaining = ingredient.quantity - usedToday;
                const reorderLevel = ingredient.reorderLevel || 20;
                const reorderAmount = (ingredient.quantity * reorderLevel / 100);
                
                if (remaining <= reorderAmount) {
                    hasItems = true;
                    const needed = Math.max(ingredient.quantity - remaining, reorderAmount * 2);
                    listHTML += `
                        <div class="stat-box">
                            <span class="stat-label">${ingredient.name}:</span>
                            <span class="stat-value">${needed.toFixed(1)} ${ingredient.unit}</span>
                        </div>
                    `;
                }
            });
            
            if (!hasItems) {
                listHTML = '<p>üéâ All items are sufficiently stocked! No shopping needed.</p>';
            }
            
            shoppingItems.innerHTML = listHTML;
            shoppingList.style.display = 'block';
        }

        // ==================== DASHBOARD UPDATES ====================
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            
            // Calculate today's totals
            let totalMade = 0;
            let totalSold = 0;
            let totalRevenue = 0;
            let totalCost = 0;
            
            sales.forEach(sale => {
                if (sale.date === today) {
                    totalMade += sale.piecesMade;
                    totalSold += sale.piecesSold;
                    
                    const recipe = recipes.find(r => r.id === sale.recipeId);
                    if (recipe) {
                        const recipeCost = calculateRecipeCost(recipe);
                        const costPerPiece = recipeCost / recipe.piecesPerBatch;
                        
                        totalRevenue += recipe.sellPrice * sale.piecesSold;
                        totalCost += costPerPiece * sale.piecesMade;
                    }
                }
            });
            
            const totalProfit = totalRevenue - totalCost;
            
            // Update dashboard
            document.getElementById('totalMade').textContent = totalMade;
            document.getElementById('totalSold').textContent = totalSold;
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
            
            // Calculate weekly stats
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const weekAgoStr = oneWeekAgo.toISOString().split('T')[0];
            
            let weekProfit = 0;
            let bestSeller = '';
            let bestSellerCount = 0;
            const salesByRecipe = {};
            
            sales.forEach(sale => {
                if (sale.date >= weekAgoStr) {
                    const recipe = recipes.find(r => r.id === sale.recipeId);
                    if (recipe) {
                        const recipeCost = calculateRecipeCost(recipe);
                        const costPerPiece = recipeCost / recipe.piecesPerBatch;
                        const profit = recipe.sellPrice * sale.piecesSold - costPerPiece * sale.piecesMade;
                        weekProfit += profit;
                        
                        // Track best seller
                        salesByRecipe[recipe.name] = (salesByRecipe[recipe.name] || 0) + sale.piecesSold;
                    }
                }
            });
            
            // Find best seller
            for (const [recipe, count] of Object.entries(salesByRecipe)) {
                if (count > bestSellerCount) {
                    bestSellerCount = count;
                    bestSeller = recipe;
                }
            }
            
            document.getElementById('weekProfit').textContent = formatCurrency(weekProfit);
            document.getElementById('bestSeller').textContent = bestSeller || '-';
            
            const profitMargin = totalCost > 0 ? ((totalProfit / totalCost) * 100) : 0;
            document.getElementById('profitMargin').textContent = `${profitMargin.toFixed(1)}%`;
        }

        // ==================== REPORTS ====================
        function generateDailyReport() {
            const today = new Date().toISOString().split('T')[0];
            let report = `<h3>üìÖ Daily Report - ${today}</h3>`;
            
            let dailySales = sales.filter(s => s.date === today);
            
            if (dailySales.length === 0) {
                report += '<p>No sales recorded today.</p>';
            } else {
                report += '<table><tr><th>Item</th><th>Made</th><th>Sold</th><th>Revenue</th><th>Profit</th></tr>';
                
                let dailyTotalRevenue = 0;
                let dailyTotalProfit = 0;
                
                dailySales.forEach(sale => {
                    const recipe = recipes.find(r => r.id === sale.recipeId);
                    if (recipe) {
                        const recipeCost = calculateRecipeCost(recipe);
                        const costPerPiece = recipeCost / recipe.piecesPerBatch;
                        const revenue = recipe.sellPrice * sale.piecesSold;
                        const profit = revenue - (costPerPiece * sale.piecesMade);
                        
                        dailyTotalRevenue += revenue;
                        dailyTotalProfit += profit;
                        
                        report += `<tr>
                            <td>${recipe.name}</td>
                            <td>${sale.piecesMade}</td>
                            <td>${sale.piecesSold}</td>
                            <td>${formatCurrency(revenue)}</td>
                            <td class="${profit >= 0 ? 'profit' : 'loss'}">${formatCurrency(profit)}</td>
                        </tr>`;
                    }
                });
                
                report += `<tr style="font-weight: bold;">
                    <td colspan="3">TOTAL</td>
                    <td>${formatCurrency(dailyTotalRevenue)}</td>
                    <td class="${dailyTotalProfit >= 0 ? 'profit' : 'loss'}">${formatCurrency(dailyTotalProfit)}</td>
                </tr>`;
                report += '</table>';
            }
            
            document.getElementById('dailyReport').innerHTML = report;
        }

        function generateWeeklyReport() {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const weekAgoStr = oneWeekAgo.toISOString().split('T')[0];
            
            let weeklySales = sales.filter(s => s.date >= weekAgoStr);
            let report = `<h3>üìÜ Weekly Report (Last 7 Days)</h3>`;
            
            if (weeklySales.length === 0) {
                report += '<p>No sales in the last 7 days.</p>';
            } else {
                let weeklyTotalRevenue = 0;
                let weeklyTotalProfit = 0;
                
                // Group by recipe
                const recipeStats = {};
                
                weeklySales.forEach(sale => {
                    const recipe = recipes.find(r => r.id === sale.recipeId);
                    if (recipe) {
                        if (!recipeStats[recipe.name]) {
                            recipeStats[recipe.name] = { made: 0, sold: 0, revenue: 0, profit: 0 };
                        }
                        
                        const recipeCost = calculateRecipeCost(recipe);
                        const costPerPiece = recipeCost / recipe.piecesPerBatch;
                        const revenue = recipe.sellPrice * sale.piecesSold;
                        const profit = revenue - (costPerPiece * sale.piecesMade);
                        
                        recipeStats[recipe.name].made += sale.piecesMade;
                        recipeStats[recipe.name].sold += sale.piecesSold;
                        recipeStats[recipe.name].revenue += revenue;
                        recipeStats[recipe.name].profit += profit;
                        
                        weeklyTotalRevenue += revenue;
                        weeklyTotalProfit += profit;
                    }
                });
                
                report += '<table><tr><th>Item</th><th>Made</th><th>Sold</th><th>Revenue</th><th>Profit</th><th>Profit Margin</th></tr>';
                
                for (const [recipeName, stats] of Object.entries(recipeStats)) {
                    const profitMargin = stats.revenue > 0 ? (stats.profit / stats.revenue * 100) : 0;
                    report += `<tr>
                        <td>${recipeName}</td>
                        <td>${stats.made}</td>
                        <td>${stats.sold}</td>
                        <td>${formatCurrency(stats.revenue)}</td>
                        <td class="${stats.profit >= 0 ? 'profit' : 'loss'}">${formatCurrency(stats.profit)}</td>
                        <td>${profitMargin.toFixed(1)}%</td>
                    </tr>`;
                }
                
                report += `<tr style="font-weight: bold;">
                    <td colspan="3">WEEKLY TOTAL</td>
                    <td>${formatCurrency(weeklyTotalRevenue)}</td>
                    <td class="${weeklyTotalProfit >= 0 ? 'profit' : 'loss'}">${formatCurrency(weeklyTotalProfit)}</td>
                    <td>${weeklyTotalRevenue > 0 ? (weeklyTotalProfit / weeklyTotalRevenue * 100).toFixed(1) : 0}%</td>
                </tr>`;
                report += '</table>';
            }
            
            document.getElementById('weeklyReport').innerHTML = report;
        }

        function generateMonthlyReport() {
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            const monthAgoStr = oneMonthAgo.toISOString().split('T')[0];
            
            let monthlySales = sales.filter(s => s.date >= monthAgoStr);
            let report = `<h3>üìà Monthly Report (Last 30 Days)</h3>`;
            
            if (monthlySales.length === 0) {
                report += '<p>No sales in the last 30 days.</p>';
            } else {
                let monthlyTotalRevenue = 0;
                let monthlyTotalProfit = 0;
                
                // Group by date
                const dailyStats = {};
                
                monthlySales.forEach(sale => {
                    if (!dailyStats[sale.date]) {
                        dailyStats[sale.date] = { revenue: 0, profit: 0 };
                    }
                    
                    const recipe = recipes.find(r => r.id === sale.recipeId);
                    if (recipe) {
                        const recipeCost = calculateRecipeCost(recipe);
                        const costPerPiece = recipeCost / recipe.piecesPerBatch;
                        const revenue = recipe.sellPrice * sale.piecesSold;
                        const profit = revenue - (costPerPiece * sale.piecesMade);
                        
                        dailyStats[sale.date].revenue += revenue;
                        dailyStats[sale.date].profit += profit;
                        
                        monthlyTotalRevenue += revenue;
                        monthlyTotalProfit += profit;
                    }
                });
                
                report += '<table><tr><th>Date</th><th>Revenue</th><th>Profit</th><th>Profit Margin</th></tr>';
                
                // Sort dates
                const sortedDates = Object.keys(dailyStats).sort();
                
                sortedDates.forEach(date => {
                    const stats = dailyStats[date];
                    const profitMargin = stats.revenue > 0 ? (stats.profit / stats.revenue * 100) : 0;
                    report += `<tr>
                        <td>${date}</td>
                        <td>${formatCurrency(stats.revenue)}</td>
                        <td class="${stats.profit >= 0 ? 'profit' : 'loss'}">${formatCurrency(stats.profit)}</td>
                        <td>${profitMargin.toFixed(1)}%</td>
                    </tr>`;
                });
                
                report += `<tr style="font-weight: bold;">
                    <td>MONTHLY TOTAL</td>
                    <td>${formatCurrency(monthlyTotalRevenue)}</td>
                    <td class="${monthlyTotalProfit >= 0 ? 'profit' : 'loss'}">${formatCurrency(monthlyTotalProfit)}</td>
                    <td>${monthlyTotalRevenue > 0 ? (monthlyTotalProfit / monthlyTotalRevenue * 100).toFixed(1) : 0}%</td>
                </tr>`;
                report += '</table>';
            }
            
            document.getElementById('monthlyReport').innerHTML = report;
        }

        function viewReport() {
            generateDailyReport();
            generateWeeklyReport();
            generateMonthlyReport();
            showTab('reports');
        }

        function exportAllData() {
            const data = {
                ingredients: ingredients,
                recipes: recipes,
                sales: sales,
                settings: settings,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `business-data-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showAlert('All data exported successfully!');
        }

        function confirmResetData() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL your data including ingredients, recipes, and sales records. This action cannot be undone!')) {
                if (confirm('Are you absolutely sure? Type "DELETE" to confirm:')) {
                    const confirmation = prompt('Type DELETE to confirm:');
                    if (confirmation === 'DELETE') {
                        localStorage.clear();
                        ingredients = [];
                        recipes = [];
                        sales = [];
                        settings = { currency: 'MVR' };
                        
                        initializeSampleData();
                        
                        loadIngredientsTable();
                        loadRecipesTable();
                        loadSalesTable();
                        loadInventoryTable();
                        updateDashboard();
                        
                        showAlert('All data has been reset. Sample data loaded.', 'error');
                    }
                }
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeSampleData();
            
            // Load all tables
            loadIngredientsTable();
            loadRecipesTable();
            loadSalesTable();
            loadInventoryTable();
            updateDashboard();
            
            // Set up event listeners for real-time updates
            document.getElementById('salesRecipe').addEventListener('change', updateProfitPreview);
            document.getElementById('piecesMadeToday').addEventListener('input', updateProfitPreview);
            document.getElementById('piecesSoldToday').addEventListener('input', updateProfitPreview);
            
            document.getElementById('recipeName').addEventListener('input', updateRecipeCostPreview);
            document.getElementById('piecesMade').addEventListener('input', updateRecipeCostPreview);
            document.getElementById('sellingPrice').addEventListener('input', updateRecipeCostPreview);
            
            // Set today's date in sales form
            document.getElementById('salesDate').value = new Date().toISOString().split('T')[0];
            
            showAlert('Business Tracker loaded successfully! Bismillah!');
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
