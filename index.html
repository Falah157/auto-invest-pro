<!DOCTYPE html>
<html>
<head>
    <title>Auto-Invest PRO</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial; background: #1a1a2e; color: white; padding: 20px; margin: 0; }
        .container { max-width: 400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .balance { font-size: 2em; font-weight: bold; color: #00ff88; text-align: center; margin: 20px 0; }
        .btn { background: #00ff88; color: black; border: none; padding: 15px; margin: 10px 0; width: 100%; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .card { background: #2d2d44; padding: 20px; border-radius: 10px; margin: 15px 0; }
        .loading { color: #888; text-align: center; }
        .price-up { color: #00ff88; }
        .price-down { color: #ff4444; }
        .input-field { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš€ Auto-Invest PRO</h1>
            <p>Smart Trading & TakeProfit</p>
        </div>
        
        <!-- Real Balance from Binance -->
        <div class="balance" id="balance">Loading...</div>
        
        <!-- Live Prices -->
        <div class="card">
            <h3>ðŸ“Š Live Prices</h3>
            <div id="prices">
                <p class="loading">Fetching prices...</p>
            </div>
        </div>
        
        <div class="card">
            <h3>Quick Actions</h3>
            <button class="btn" onclick="createStrategy()">âž• Create Strategy</button>
            <button class="btn" onclick="quickTrade()">âš¡ Quick Trade</button>
            <button class="btn" style="background: #ff4444;" onclick="emergencyStop()">ðŸ›‘ Emergency Stop</button>
        </div>
        
        <!-- Real Active Bots -->
        <div class="card">
            <h3>Active Bots</h3>
            <div id="activeBots">
                <p class="loading">Loading bots...</p>
            </div>
        </div>

        <!-- Portfolio Stats -->
        <div class="card">
            <h3>ðŸ“ˆ Portfolio</h3>
            <div id="portfolioStats">
                <p class="loading">Loading portfolio...</p>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // Binance API Configuration (Use environment variables in production)
        const BINANCE_API_URL = 'https://api.binance.com/api/v3';
        const TEST_MODE = true; // Set to false for real trading

        // Real-time data storage
        let userBalance = 0;
        let activeBots = [];
        let prices = {};

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadRealData();
            startLiveUpdates();
        });

        // Load real data from Binance
        async function loadRealData() {
            try {
                await updateBalance();
                await updatePrices();
                await updateActiveBots();
                updatePortfolioStats();
            } catch (error) {
                console.error('Error loading data:', error);
                tg.showAlert('Error connecting to exchange');
            }
        }

        // Get user balance (simulated - replace with real API calls)
        async function updateBalance() {
            if (TEST_MODE) {
                // Simulated balance for demo
                userBalance = 15392.50;
                document.getElementById('balance').textContent = `$${userBalance.toLocaleString()}`;
            } else {
                // Real Binance API call (requires backend for security)
                const response = await axios.get('/api/binance/balance');
                userBalance = response.data.totalBalance;
                document.getElementById('balance').textContent = `$${userBalance.toLocaleString()}`;
            }
        }

        // Get live prices from Binance Public API
        async function updatePrices() {
            try {
                const symbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'ADAUSDT'];
                const pricePromises = symbols.map(symbol => 
                    axios.get(`${BINANCE_API_URL}/ticker/price?symbol=${symbol}`)
                );
                
                const responses = await Promise.all(pricePromises);
                const pricesContainer = document.getElementById('prices');
                pricesContainer.innerHTML = '';
                
                responses.forEach((response, index) => {
                    const symbol = symbols[index];
                    const price = parseFloat(response.data.price).toFixed(2);
                    prices[symbol] = price;
                    
                    const priceElement = document.createElement('p');
                    priceElement.innerHTML = `â€¢ ${symbol.replace('USDT', '')}: $${price}`;
                    pricesContainer.appendChild(priceElement);
                });
            } catch (error) {
                console.error('Error fetching prices:', error);
            }
        }

        // Real bot management
        async function updateActiveBots() {
            // Load bots from localStorage or backend
            const savedBots = JSON.parse(localStorage.getItem('activeBots') || '[]');
            activeBots = savedBots;
            
            const botsContainer = document.getElementById('activeBots');
            botsContainer.innerHTML = '';
            
            if (activeBots.length === 0) {
                botsContainer.innerHTML = '<p>No active bots</p>';
                return;
            }
            
            activeBots.forEach(bot => {
                const botElement = document.createElement('p');
                const statusColor = bot.status === 'running' ? '#00ff88' : '#ff4444';
                botElement.innerHTML = `â€¢ ${bot.name}: <span style="color: ${statusColor}">${bot.status}</span>`;
                botsContainer.appendChild(botElement);
            });
        }

        // Portfolio statistics
        function updatePortfolioStats() {
            const statsContainer = document.getElementById('portfolioStats');
            statsContainer.innerHTML = `
                <p>â€¢ Total Value: $${userBalance.toLocaleString()}</p>
                <p>â€¢ 24h Change: <span class="price-up">+$284.60 â†—</span></p>
                <p>â€¢ Active Strategies: ${activeBots.length}</p>
                <p>â€¢ Available: $${(userBalance * 0.3).toLocaleString()}</p>
            `;
        }

        // Real strategy creation
        function createStrategy() {
            tg.showPopup({
                title: 'Create Strategy',
                message: 'Choose strategy type',
                buttons: [
                    {id: 'dca', type: 'default', text: 'ðŸ’° DCA Bot'},
                    {id: 'grid', type: 'default', text: 'ðŸ“Š Grid Trading'},
                    {id: 'tp', type: 'default', text: 'ðŸŽ¯ TakeProfit'},
                    {type: 'cancel'}
                ]
            }, function(buttonId) {
                if (buttonId === 'dca') showDCAForm();
                else if (buttonId === 'grid') showGridForm();
                else if (buttonId === 'tp') showTakeProfitForm();
            });
        }

        // DCA Strategy Form
        function showDCAForm() {
            tg.showPopup({
                title: 'DCA Bot Setup',
                message: 'Configure your DCA strategy',
                buttons: [
                    {id: 'create', type: 'default', text: 'Create DCA Bot'},
                    {type: 'cancel'}
                ]
            }, async function(buttonId) {
                if (buttonId === 'create') {
                    // Create real DCA bot
                    const newBot = {
                        id: Date.now(),
                        name: 'BTC DCA Bot',
                        type: 'dca',
                        symbol: 'BTCUSDT',
                        amount: 100,
                        frequency: 'daily',
                        status: 'running',
                        createdAt: new Date().toISOString()
                    };
                    
                    activeBots.push(newBot);
                    localStorage.setItem('activeBots', JSON.stringify(activeBots));
                    
                    tg.showAlert('âœ… DCA Bot Started!');
                    updateActiveBots();
                    
                    // Start the actual DCA logic
                    startRealDCA(newBot);
                }
            });
        }

        // Real DCA Logic
        async function startRealDCA(botConfig) {
            if (TEST_MODE) {
                console.log('DCA Bot running in test mode:', botConfig);
                // Simulated trading
                return;
            }
            
            // Real trading logic would go here
            try {
                // This would be a secure backend call
                const response = await axios.post('/api/bots/dca', botConfig);
                console.log('DCA bot started on server:', response.data);
            } catch (error) {
                console.error('Error starting DCA bot:', error);
                tg.showAlert('Error starting DCA bot');
            }
        }

        // Quick Trade with real execution
        function quickTrade() {
            tg.showPopup({
                title: 'Quick Trade',
                message: 'Select trade type',
                buttons: [
                    {id: 'market_buy', type: 'default', text: 'ðŸŸ¢ Market Buy'},
                    {id: 'market_sell', type: 'default', text: 'ðŸ”´ Market Sell'},
                    {id: 'limit', type: 'default', text: 'âš¡ Limit Order'},
                    {type: 'cancel'}
                ]
            }, function(buttonId) {
                if (buttonId === 'market_buy') executeMarketOrder('BUY');
                else if (buttonId === 'market_sell') executeMarketOrder('SELL');
                else if (buttonId === 'limit') showLimitOrderForm();
            });
        }

        // Execute market order
        async function executeMarketOrder(side) {
            if (TEST_MODE) {
                tg.showAlert(`âœ… ${side} order executed (Test Mode)`);
                return;
            }
            
            try {
                // Real order execution (requires backend)
                const order = {
                    symbol: 'BTCUSDT',
                    side: side,
                    type: 'MARKET',
                    quantity: 0.001
                };
                
                const response = await axios.post('/api/binance/order', order);
                tg.showAlert(`âœ… ${side} order filled at $${response.data.price}`);
            } catch (error) {
                tg.showAlert('âŒ Order failed');
            }
        }

        // Emergency stop - cancel all orders and stop bots
        function emergencyStop() {
            tg.showConfirm("Stop ALL trading and cancel orders?", async function(confirmed) {
                if (confirmed) {
                    try {
                        // Stop all bots
                        activeBots.forEach(bot => bot.status = 'stopped');
                        localStorage.setItem('activeBots', JSON.stringify(activeBots));
                        
                        if (!TEST_MODE) {
                            // Cancel all real orders
                            await axios.post('/api/binance/cancel-all-orders');
                        }
                        
                        tg.showAlert("ðŸ›‘ ALL trading stopped! Orders cancelled.");
                        updateActiveBots();
                    } catch (error) {
                        tg.showAlert("Error stopping trading");
                    }
                }
            });
        }

        // Live updates every 10 seconds
        function startLiveUpdates() {
            setInterval(() => {
                updatePrices();
                if (!TEST_MODE) {
                    updateBalance();
                }
            }, 10000);
        }

        // Add this to simulate real trading in test mode
        function simulateTrading() {
            if (TEST_MODE && Math.random() > 0.7) {
                const change = (Math.random() - 0.5) * 100;
                userBalance += change;
                document.getElementById('balance').textContent = `$${userBalance.toLocaleString()}`;
                updatePortfolioStats();
            }
        }

        // Start simulation
        setInterval(simulateTrading, 30000);
    </script>
</body>
</html>
