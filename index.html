<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Islamic Speed Racer - Car Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* RESET & BASE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            height: 100vh;
        }

        /* GAME CONTAINER - FULLSCREEN */
        .game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* GAME CANVAS - FULLSCREEN */
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #0c2461, #1e3799);
        }

        /* MINIMAL CONTROL PANEL */
        .control-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 100;
        }

        .mini-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #f1c40f;
            color: #f1c40f;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .mini-btn:hover {
            background: #f1c40f;
            color: #000;
            transform: scale(1.1);
        }

        /* GAME STATS - MINIMAL */
        .game-stats {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #2ecc71;
            display: flex;
            gap: 15px;
            z-index: 100;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #2ecc71;
        }

        .stat-label {
            font-size: 10px;
            color: #ecf0f1;
            text-transform: uppercase;
        }

        /* SPEEDOMETER */
        .speedometer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 120px;
            z-index: 100;
        }

        .speed-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #e74c3c;
            transform: rotate(45deg);
        }

        .speed-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
        }

        .speed-label {
            position: absolute;
            top: calc(50% + 25px);
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #ecf0f1;
            text-transform: uppercase;
        }

        /* ISLAMIC THEME ELEMENTS */
        .islamic-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255,255,255,0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 50;
        }

        .quran-verse {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            text-align: center;
            max-width: 80%;
            z-index: 100;
        }

        /* MOBILE CONTROLS */
        .mobile-controls {
            position: fixed;
            bottom: 100px;
            left: 0;
            right: 0;
            display: none;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }

        .mobile-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #3498db;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
        }

        /* GAME OVER SCREEN */
        .game-over {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            display: none;
            z-index: 1000;
            border: 3px solid #f1c40f;
            width: 90%;
            max-width: 400px;
        }

        .game-over h2 {
            color: #e74c3c;
            font-size: 32px;
            margin-bottom: 20px;
        }

        .final-stats {
            margin: 20px 0;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        /* START SCREEN */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .game-logo {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            background: linear-gradient(to right, #f1c40f, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .game-instructions {
            text-align: center;
            margin-bottom: 30px;
            max-width: 500px;
        }

        .instruction-item {
            margin: 10px 0;
            color: #ecf0f1;
            font-size: 14px;
        }

        .start-btn {
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
            border: none;
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        /* PAUSE SCREEN */
        .pause-screen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            display: none;
            z-index: 1000;
            border: 3px solid #3498db;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .game-stats {
                top: 5px;
                left: 5px;
                padding: 5px 10px;
                gap: 10px;
            }

            .stat-value {
                font-size: 16px;
            }

            .speedometer {
                width: 80px;
                height: 80px;
                bottom: 10px;
                right: 10px;
            }

            .speed-value {
                font-size: 18px;
            }

            .mobile-controls {
                display: flex;
            }
        }

        @media (max-height: 600px) {
            .game-stats {
                top: 5px;
                padding: 5px;
            }

            .speedometer {
                bottom: 5px;
                right: 5px;
                width: 70px;
                height: 70px;
            }
        }

        /* ANIMATIONS */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .blink {
            animation: blink 1s infinite;
        }
    </style>
</head>
<body>
    <!-- START SCREEN -->
    <div class="start-screen" id="startScreen">
        <div class="game-logo">ISLAMIC SPEED RACER</div>
        <div class="game-instructions">
            <div class="instruction-item">ðŸš— Drive through Islamic cities at high speed</div>
            <div class="instruction-item">ðŸ•Œ Avoid obstacles and collect blessings</div>
            <div class="instruction-item">ðŸ“¿ Complete the race before time runs out</div>
            <div class="instruction-item">ðŸ•‹ Reach Makkah to win!</div>
        </div>
        <button class="start-btn" id="startGameBtn">
            <i class="fas fa-play"></i> START RACE
        </button>
    </div>

    <!-- GAME CONTAINER -->
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <!-- MINIMAL CONTROL PANEL -->
        <div class="control-panel">
            <button class="mini-btn" id="pauseBtn" title="Pause">
                <i class="fas fa-pause"></i>
            </button>
            <button class="mini-btn" id="soundBtn" title="Sound On/Off">
                <i class="fas fa-volume-up"></i>
            </button>
            <button class="mini-btn" id="fullscreenBtn" title="Fullscreen">
                <i class="fas fa-expand"></i>
            </button>
        </div>

        <!-- GAME STATS -->
        <div class="game-stats">
            <div class="stat-item">
                <div class="stat-value" id="score">0</div>
                <div class="stat-label">Score</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="time">60</div>
                <div class="stat-label">Time</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="distance">0</div>
                <div class="stat-label">KM</div>
            </div>
        </div>

        <!-- SPEEDOMETER -->
        <div class="speedometer">
            <div class="speed-circle" id="speedCircle"></div>
            <div class="speed-value" id="speedValue">0</div>
            <div class="speed-label">KM/H</div>
        </div>

        <!-- ISLAMIC ELEMENTS -->
        <div class="islamic-overlay"></div>
        <div class="quran-verse" id="quranVerse">
            "And He has made for you from ships and animals those which you ride." (Quran 43:12)
        </div>

        <!-- MOBILE CONTROLS -->
        <div class="mobile-controls">
            <div class="mobile-btn" id="leftBtn">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="mobile-btn" id="rightBtn">
                <i class="fas fa-arrow-right"></i>
            </div>
        </div>

        <!-- PAUSE SCREEN -->
        <div class="pause-screen" id="pauseScreen">
            <h2>GAME PAUSED</h2>
            <button class="start-btn" id="resumeBtn" style="margin: 10px;">
                <i class="fas fa-play"></i> RESUME
            </button>
            <button class="start-btn" style="background: linear-gradient(to bottom, #e74c3c, #c0392b); margin: 10px;">
                <i class="fas fa-redo"></i> RESTART
            </button>
        </div>

        <!-- GAME OVER SCREEN -->
        <div class="game-over" id="gameOverScreen">
            <h2 id="gameOverTitle">RACE COMPLETE!</h2>
            <div class="final-stats">
                <div class="stat-row">
                    <span>Final Score:</span>
                    <span id="finalScore">0</span>
                </div>
                <div class="stat-row">
                    <span>Distance:</span>
                    <span id="finalDistance">0 KM</span>
                </div>
                <div class="stat-row">
                    <span>Time Remaining:</span>
                    <span id="finalTime">0s</span>
                </div>
            </div>
            <button class="start-btn" id="playAgainBtn">
                <i class="fas fa-redo"></i> PLAY AGAIN
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // ISLAMIC SPEED RACER - CAR GAME
        // ============================================

        // Game variables
        let canvas, ctx;
        let gameRunning = false;
        let gamePaused = false;
        let score = 0;
        let distance = 0;
        let timeLeft = 60;
        let speed = 0;
        let maxSpeed = 200;
        let acceleration = 0.5;
        let deceleration = 0.3;
        let gameLoop;
        let soundEnabled = true;
        let lastTime = 0;

        // Car variables
        let car = {
            x: 0,
            y: 0,
            width: 60,
            height: 100,
            color: '#3498db',
            lane: 1, // 0 = left, 1 = middle, 2 = right
            maxLanes: 3
        };

        // Road variables
        let road = {
            width: 400,
            lanes: 3,
            markingWidth: 10,
            markingGap: 30,
            markingOffset: 0
        };

        // Game objects
        let obstacles = [];
        let collectibles = [];
        let particles = [];
        let buildings = [];

        // Keys object
        let keys = {
            ArrowLeft: false,
            ArrowRight: false,
            ArrowUp: false,
            ArrowDown: false
        };

        // Islamic-themed collectibles
        const collectibleTypes = [
            { type: 'prayer', symbol: 'ðŸ•Œ', color: '#2ecc71', points: 100 },
            { type: 'quran', symbol: 'ðŸ“–', color: '#f1c40f', points: 50 },
            { type: 'charity', symbol: 'ðŸ’°', color: '#9b59b6', points: 75 },
            { type: 'fasting', symbol: 'ðŸŒ™', color: '#3498db', points: 60 }
        ];

        // Islamic-themed obstacles
        const obstacleTypes = [
            { type: 'rock', symbol: 'ðŸª¨', color: '#7f8c8d' },
            { type: 'camel', symbol: 'ðŸ«', color: '#d35400' },
            { type: 'barrier', symbol: 'ðŸš§', color: '#e74c3c' },
            { type: 'tree', symbol: 'ðŸŒ³', color: '#27ae60' }
        ];

        // Quran verses
        const quranVerses = [
            "And He has made for you from ships and animals those which you ride. (43:12)",
            "Travel through the land and observe how He began creation. (29:20)",
            "And Allah has made for you from your homes a place of rest. (16:80)",
            "Whoever does righteousness - it is for his own soul. (41:46)"
        ];

        // Initialize game
        function init() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // Set canvas size to full window
            resizeCanvas();
            
            // Set initial car position
            resetCarPosition();
            
            // Setup event listeners
            setupEventListeners();
            
            // Start game loop
            requestAnimationFrame(gameUpdate);
        }

        // Resize canvas to window
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            resetCarPosition();
        }

        // Reset car position
        function resetCarPosition() {
            car.x = canvas.width / 2 - car.width / 2;
            car.y = canvas.height - car.height - 50;
            car.lane = 1;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                if (keys.hasOwnProperty(e.key)) {
                    keys[e.key] = true;
                    e.preventDefault();
                }
            });

            document.addEventListener('keyup', (e) => {
                if (keys.hasOwnProperty(e.key)) {
                    keys[e.key] = false;
                    e.preventDefault();
                }
            });

            // Window resize
            window.addEventListener('resize', resizeCanvas);

            // Game control buttons
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('pauseBtn').addEventListener('click', togglePause);
            document.getElementById('resumeBtn').addEventListener('click', togglePause);
            document.getElementById('playAgainBtn').addEventListener('click', restartGame);
            document.getElementById('soundBtn').addEventListener('click', toggleSound);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);

            // Mobile controls
            document.getElementById('leftBtn').addEventListener('touchstart', () => keys.ArrowLeft = true);
            document.getElementById('leftBtn').addEventListener('touchend', () => keys.ArrowLeft = false);
            document.getElementById('rightBtn').addEventListener('touchstart', () => keys.ArrowRight = true);
            document.getElementById('rightBtn').addEventListener('touchend', () => keys.ArrowRight = false);

            // Touch controls for acceleration
            canvas.addEventListener('touchstart', (e) => {
                keys.ArrowUp = true;
                e.preventDefault();
            });

            canvas.addEventListener('touchend', (e) => {
                keys.ArrowUp = false;
                e.preventDefault();
            });

            // Mouse controls
            canvas.addEventListener('mousedown', () => keys.ArrowUp = true);
            canvas.addEventListener('mouseup', () => keys.ArrowUp = false);

            // Prevent context menu
            canvas.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        // Start game
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            gameRunning = true;
            gamePaused = false;
            
            // Reset game variables
            score = 0;
            distance = 0;
            timeLeft = 60;
            speed = 0;
            
            // Clear arrays
            obstacles = [];
            collectibles = [];
            particles = [];
            buildings = [];
            
            // Create initial buildings
            createBuildings();
            
            // Update UI
            updateUI();
        }

        // Game update loop
        function gameUpdate(currentTime) {
            const deltaTime = Math.min(currentTime - lastTime, 100) / 16; // Normalize delta time
            lastTime = currentTime;
            
            if (!gameRunning || gamePaused) {
                requestAnimationFrame(gameUpdate);
                return;
            }
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw background
            drawBackground();
            
            // Draw road
            drawRoad();
            
            // Draw buildings
            drawBuildings();
            
            // Update and draw objects
            updateObjects(deltaTime);
            
            // Draw car
            drawCar();
            
            // Draw particles
            drawParticles();
            
            // Draw HUD
            drawHUD();
            
            // Update game state
            updateGameState(deltaTime);
            
            // Check collisions
            checkCollisions();
            
            // Continue game loop
            requestAnimationFrame(gameUpdate);
        }

        // Draw background
        function drawBackground() {
            // Sky gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0c2461');
            gradient.addColorStop(1, '#1e3799');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Stars
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            for (let i = 0; i < 50; i++) {
                const x = (i * 13.7) % canvas.width;
                const y = (i * 8.3) % (canvas.height / 2);
                const size = Math.random() * 2;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Moon
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.beginPath();
            ctx.arc(canvas.width - 100, 100, 40, 0, Math.PI * 2);
            ctx.fill();
            
            // Crescent inside moon
            ctx.fillStyle = '#0c2461';
            ctx.beginPath();
            ctx.arc(canvas.width - 115, 85, 35, 0, Math.PI * 2);
            ctx.fill();
        }

        // Draw road
        function drawRoad() {
            const roadX = (canvas.width - road.width) / 2;
            
            // Road surface
            ctx.fillStyle = '#34495e';
            ctx.fillRect(roadX, 0, road.width, canvas.height);
            
            // Road edges
            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(roadX - 10, 0, 10, canvas.height);
            ctx.fillRect(roadX + road.width, 0, 10, canvas.height);
            
            // Lane markings
            ctx.fillStyle = '#f1c40f';
            const laneWidth = road.width / road.lanes;
            
            for (let i = 1; i < road.lanes; i++) {
                const x = roadX + i * laneWidth - road.markingWidth / 2;
                
                // Draw dashed line
                for (let y = road.markingOffset % (road.markingGap * 2); y < canvas.height; y += road.markingGap * 2) {
                    ctx.fillRect(x, y, road.markingWidth, road.markingGap);
                }
            }
            
            // Animate road markings
            road.markingOffset += speed * 0.1;
        }

        // Draw car
        function drawCar() {
            const laneWidth = road.width / car.maxLanes;
            const roadX = (canvas.width - road.width) / 2;
            
            // Calculate target position based on lane
            const targetX = roadX + (car.lane + 0.5) * laneWidth - car.width / 2;
            
            // Smooth lane changing
            car.x += (targetX - car.x) * 0.1;
            
            // Car body
            ctx.fillStyle = car.color;
            ctx.fillRect(car.x, car.y, car.width, car.height);
            
            // Car details
            ctx.fillStyle = '#2980b9';
            ctx.fillRect(car.x + 5, car.y + 5, car.width - 10, 20); // Roof
            ctx.fillRect(car.x + 10, car.y + car.height - 20, 15, 15); // Wheel
            ctx.fillRect(car.x + car.width - 25, car.y + car.height - 20, 15, 15); // Wheel
            
            // Windows
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(car.x + 10, car.y + 30, car.width - 20, 30);
            
            // Headlights
            ctx.fillStyle = '#f1c40f';
            ctx.fillRect(car.x, car.y + 20, 5, 10);
            ctx.fillRect(car.x + car.width - 5, car.y + 20, 5, 10);
            
            // Taillights
            if (speed > 0) {
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(car.x, car.y + car.height - 15, 5, 10);
                ctx.fillRect(car.x + car.width - 5, car.y + car.height - 15, 5, 10);
            }
            
            // Speed lines effect
            if (speed > 100) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.lineWidth = 2;
                for (let i = 0; i < 5; i++) {
                    ctx.beginPath();
                    ctx.moveTo(car.x + Math.random() * car.width, car.y + car.height);
                    ctx.lineTo(car.x + Math.random() * car.width, car.y + car.height + 50);
                    ctx.stroke();
                }
            }
        }

        // Create buildings
        function createBuildings() {
            buildings = [];
            const buildingTypes = ['ðŸ•Œ', 'ðŸ¢', 'ðŸ›ï¸', 'ðŸ¨', 'ðŸ '];
            const buildingColors = ['#2ecc71', '#3498db', '#9b59b6', '#e74c3c', '#f39c12'];
            
            for (let i = 0; i < 20; i++) {
                const side = Math.random() > 0.5 ? 'left' : 'right';
                const x = side === 'left' 
                    ? Math.random() * (canvas.width / 2 - road.width / 2 - 100)
                    : canvas.width / 2 + road.width / 2 + Math.random() * (canvas.width / 2 - road.width / 2 - 100);
                
                buildings.push({
                    x: x,
                    y: -Math.random() * canvas.height,
                    width: 60 + Math.random() * 60,
                    height: 100 + Math.random() * 200,
                    color: buildingColors[Math.floor(Math.random() * buildingColors.length)],
                    symbol: buildingTypes[Math.floor(Math.random() * buildingTypes.length)],
                    speed: 2 + Math.random() * 3
                });
            }
        }

        // Draw buildings
        function drawBuildings() {
            buildings.forEach(building => {
                // Update position
                building.y += building.speed * (speed / 50);
                
                // Reset if off screen
                if (building.y > canvas.height) {
                    building.y = -building.height;
                    building.x = Math.random() > 0.5 
                        ? Math.random() * (canvas.width / 2 - road.width / 2 - 100)
                        : canvas.width / 2 + road.width / 2 + Math.random() * (canvas.width / 2 - road.width / 2 - 100);
                }
                
                // Draw building
                ctx.fillStyle = building.color;
                ctx.fillRect(building.x, building.y, building.width, building.height);
                
                // Draw windows
                ctx.fillStyle = '#f1c40f';
                const windowSize = 8;
                const windowGap = 15;
                for (let wx = building.x + 10; wx < building.x + building.width - 10; wx += windowGap) {
                    for (let wy = building.y + 10; wy < building.y + building.height - 10; wy += windowGap) {
                        if (Math.random() > 0.3) {
                            ctx.fillRect(wx, wy, windowSize, windowSize);
                        }
                    }
                }
                
                // Draw symbol
                ctx.fillStyle = 'white';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(building.symbol, building.x + building.width / 2, building.y + 30);
            });
        }

        // Update objects
        function updateObjects(deltaTime) {
            // Update speed based on input
            if (keys.ArrowUp) {
                speed = Math.min(speed + acceleration * deltaTime, maxSpeed);
            } else {
                speed = Math.max(speed - deceleration * deltaTime, 0);
            }
            
            // Update distance
            distance += speed * 0.01;
            
            // Handle lane changing
            if (keys.ArrowLeft && car.lane > 0) {
                car.lane--;
                keys.ArrowLeft = false;
                createParticles(car.x + car.width / 2, car.y + car.height, '#3498db');
            }
            
            if (keys.ArrowRight && car.lane < car.maxLanes - 1) {
                car.lane++;
                keys.ArrowRight = false;
                createParticles(car.x + car.width / 2, car.y + car.height, '#3498db');
            }
            
            // Spawn obstacles
            if (Math.random() < 0.02 * (speed / 100) && obstacles.length < 5) {
                spawnObstacle();
            }
            
            // Spawn collectibles
            if (Math.random() < 0.03 * (speed / 100) && collectibles.length < 3) {
                spawnCollectible();
            }
            
            // Update obstacles
            obstacles.forEach((obstacle, index) => {
                obstacle.y += (3 + speed * 0.05) * deltaTime;
                
                // Remove if off screen
                if (obstacle.y > canvas.height) {
                    obstacles.splice(index, 1);
                }
            });
            
            // Update collectibles
            collectibles.forEach((collectible, index) => {
                collectible.y += (2 + speed * 0.03) * deltaTime;
                
                // Remove if off screen
                if (collectible.y > canvas.height) {
                    collectibles.splice(index, 1);
                }
            });
            
            // Update particles
            particles.forEach((particle, index) => {
                particle.y += particle.speed;
                particle.life -= 0.02;
                
                // Remove if dead
                if (particle.life <= 0) {
                    particles.splice(index, 1);
                }
            });
            
            // Draw obstacles
            drawObstacles();
            
            // Draw collectibles
            drawCollectibles();
        }

        // Draw obstacles
        function drawObstacles() {
            obstacles.forEach(obstacle => {
                ctx.save();
                ctx.translate(obstacle.x, obstacle.y);
                
                // Draw obstacle
                ctx.fillStyle = obstacle.color;
                ctx.beginPath();
                ctx.arc(0, 0, obstacle.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw symbol
                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(obstacle.symbol, 0, 0);
                
                ctx.restore();
            });
        }

        // Draw collectibles
        function drawCollectibles() {
            collectibles.forEach(collectible => {
                ctx.save();
                ctx.translate(collectible.x, collectible.y);
                
                // Draw glow effect
                ctx.shadowColor = collectible.color;
                ctx.shadowBlur = 15;
                
                // Draw collectible
                ctx.fillStyle = collectible.color;
                ctx.beginPath();
                ctx.arc(0, 0, collectible.radius, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.shadowBlur = 0;
                
                // Draw symbol
                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(collectible.symbol, 0, 0);
                
                ctx.restore();
            });
        }

        // Spawn obstacle
        function spawnObstacle() {
            const laneWidth = road.width / car.maxLanes;
            const roadX = (canvas.width - road.width) / 2;
            const lane = Math.floor(Math.random() * car.maxLanes);
            const obstacleType = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
            
            obstacles.push({
                x: roadX + (lane + 0.5) * laneWidth,
                y: -50,
                radius: 25,
                speed: 3,
                color: obstacleType.color,
                symbol: obstacleType.symbol,
                type: obstacleType.type
            });
        }

        // Spawn collectible
        function spawnCollectible() {
            const laneWidth = road.width / car.maxLanes;
            const roadX = (canvas.width - road.width) / 2;
            const lane = Math.floor(Math.random() * car.maxLanes);
            const collectibleType = collectibleTypes[Math.floor(Math.random() * collectibleTypes.length)];
            
            collectibles.push({
                x: roadX + (lane + 0.5) * laneWidth,
                y: -50,
                radius: 20,
                speed: 2,
                color: collectibleType.color,
                symbol: collectibleType.symbol,
                type: collectibleType.type,
                points: collectibleType.points
            });
        }

        // Create particles
        function createParticles(x, y, color) {
            for (let i = 0; i < 10; i++) {
                particles.push({
                    x: x + Math.random() * 20 - 10,
                    y: y + Math.random() * 20 - 10,
                    radius: Math.random() * 3 + 1,
                    speed: Math.random() * 3 + 1,
                    color: color,
                    life: 1
                });
            }
        }

        // Draw particles
        function drawParticles() {
            particles.forEach(particle => {
                ctx.globalAlpha = particle.life;
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });
        }

        // Draw HUD
        function drawHUD() {
            // Draw score
            ctx.fillStyle = 'white';
            ctx.font = '16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`SCORE: ${score}`, 20, 30);
            
            // Draw distance
            ctx.fillText(`DISTANCE: ${distance.toFixed(1)} KM`, 20, 60);
            
            // Draw time
            ctx.fillText(`TIME: ${timeLeft.toFixed(1)}s`, 20, 90);
            
            // Draw speed
            ctx.fillText(`SPEED: ${speed.toFixed(0)} KM/H`, 20, 120);
            
            // Draw controls hint
            if (speed === 0) {
                ctx.textAlign = 'center';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.font = '14px Arial';
                ctx.fillText('Press UP or tap screen to accelerate', canvas.width / 2, canvas.height - 50);
                ctx.fillText('Use LEFT/RIGHT arrows to change lanes', canvas.width / 2, canvas.height - 30);
            }
            
            // Draw finish line progress
            if (distance < 5) {
                const progress = distance / 5;
                ctx.fillStyle = 'rgba(46, 204, 113, 0.5)';
                ctx.fillRect(canvas.width / 2 - 100, canvas.height - 20, 200 * progress, 10);
                ctx.strokeStyle = '#2ecc71';
                ctx.strokeRect(canvas.width / 2 - 100, canvas.height - 20, 200, 10);
                
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.fillText('TO MAKKAH', canvas.width / 2, canvas.height - 25);
            }
        }

        // Update game state
        function updateGameState(deltaTime) {
            // Update time
            timeLeft -= 0.016 * deltaTime;
            
            // Check game over conditions
            if (timeLeft <= 0) {
                gameOver(false);
                return;
            }
            
            if (distance >= 5) {
                gameOver(true);
                return;
            }
            
            // Update UI
            updateUI();
            
            // Randomly change Quran verse
            if (Math.random() < 0.001) {
                document.getElementById('quranVerse').textContent = 
                    quranVerses[Math.floor(Math.random() * quranVerses.length)];
            }
        }

        // Check collisions
        function checkCollisions() {
            // Car bounds
            const carBounds = {
                x: car.x,
                y: car.y,
                width: car.width,
                height: car.height
            };
            
            // Check collision with obstacles
            obstacles.forEach((obstacle, index) => {
                const dx = carBounds.x + carBounds.width/2 - obstacle.x;
                const dy = carBounds.y + carBounds.height/2 - obstacle.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < (carBounds.width/2 + obstacle.radius)) {
                    // Collision detected
                    score -= 50;
                    if (score < 0) score = 0;
                    speed = Math.max(speed - 30, 0);
                    obstacles.splice(index, 1);
                    createParticles(obstacle.x, obstacle.y, '#e74c3c');
                    playSound('crash');
                }
            });
            
            // Check collision with collectibles
            collectibles.forEach((collectible, index) => {
                const dx = carBounds.x + carBounds.width/2 - collectible.x;
                const dy = carBounds.y + carBounds.height/2 - collectible.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < (carBounds.width/2 + collectible.radius)) {
                    // Collectible collected
                    score += collectible.points;
                    timeLeft += 2; // Bonus time
                    collectibles.splice(index, 1);
                    createParticles(collectible.x, collectible.y, collectible.color);
                    playSound('collect');
                }
            });
        }

        // Update UI
        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('time').textContent = timeLeft.toFixed(0);
            document.getElementById('distance').textContent = distance.toFixed(1);
            document.getElementById('speedValue').textContent = speed.toFixed(0);
            
            // Update speedometer circle
            const speedPercent = speed / maxSpeed;
            const speedCircle = document.getElementById('speedCircle');
            speedCircle.style.borderTopColor = speedPercent > 0.8 ? '#e74c3c' : '#2ecc71';
            speedCircle.style.transform = `rotate(${45 + speedPercent * 270}deg)`;
        }

        // Game over
        function gameOver(success) {
            gameRunning = false;
            
            document.getElementById('gameOverTitle').textContent = 
                success ? 'RACE COMPLETE!' : 'TIME UP!';
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalDistance').textContent = distance.toFixed(1) + ' KM';
            document.getElementById('finalTime').textContent = timeLeft.toFixed(1) + 's';
            
            // Bonus points for remaining time
            if (success) {
                score += Math.floor(timeLeft * 10);
                document.getElementById('finalScore').textContent = score;
            }
            
            document.getElementById('gameOverScreen').style.display = 'block';
        }

        // Toggle pause
        function togglePause() {
            if (!gameRunning) return;
            
            gamePaused = !gamePaused;
            document.getElementById('pauseScreen').style.display = gamePaused ? 'block' : 'none';
            document.getElementById('pauseBtn').innerHTML = gamePaused ? 
                '<i class="fas fa-play"></i>' : 
                '<i class="fas fa-pause"></i>';
        }

        // Restart game
        function restartGame() {
            document.getElementById('gameOverScreen').style.display = 'none';
            startGame();
        }

        // Toggle sound
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundBtn').innerHTML = soundEnabled ? 
                '<i class="fas fa-volume-up"></i>' : 
                '<i class="fas fa-volume-mute"></i>';
        }

        // Toggle fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // Play sound
        function playSound(type) {
            if (!soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch(type) {
                    case 'collect':
                        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                        oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2);
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                        break;
                        
                    case 'crash':
                        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                        break;
                }
            } catch (e) {
                console.log('Audio not supported:', e);
            }
        }

        // Initialize when page loads
        window.addEventListener('load', init);

        // Export for debugging
        window.game = {
            startGame,
            togglePause,
            restartGame,
            getState: () => ({ score, distance, timeLeft, speed })
        };

        console.log('Islamic Speed Racer Game Loaded!');
        console.log('Controls: Arrow keys to drive, reach Makkah in 5KM');
    </script>
</body>
</html>
