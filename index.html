{
  "name": "souk-al-rahma",
  "version": "1.0.0",
  "description": "Halal Marketplace - Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…",
  "main": "bot.js",
  "scripts": {
    "start": "node bot.js",
    "dev": "nodemon bot.js"
  },
  "dependencies": {
    "telegraf": "^4.12.2",
    "express": "^4.18.2"
  }
}
// Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù
// Souk Al-Rahma - Complete Halal Marketplace
// REPLACE "YOUR_BOT_TOKEN_HERE" with your actual bot token!

const { Telegraf } = require('telegraf');
const express = require('express');

const app = express();
const bot = new Telegraf('YOUR_BOT_TOKEN_HERE'); // â† REPLACE THIS!

// Quranic Foundation
const quranicVerses = [
    "ÙˆÙØ£ÙØ­ÙÙ„ÙÙ‘ Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ù’Ø¨ÙÙŠÙ’Ø¹Ù ÙˆÙØ­ÙØ±ÙÙ‘Ù…Ù Ø§Ù„Ø±ÙÙ‘Ø¨ÙØ§ - Allah has permitted trade and has forbidden interest (2:275)",
    "ÙŠÙØ§ Ø£ÙÙŠÙÙ‘Ù‡ÙØ§ Ø§Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù Ø¢Ù…ÙÙ†ÙÙˆØ§ Ø¥ÙØ°ÙØ§ ØªÙØ¯ÙØ§ÙŠÙÙ†ØªÙÙ… Ø¨ÙØ¯ÙÙŠÙ’Ù†Ù Ø¥ÙÙ„ÙÙ‰Ù° Ø£ÙØ¬ÙÙ„Ù Ù…ÙÙ‘Ø³ÙÙ…Ù‹Ù‘Ù‰ ÙÙØ§ÙƒÙ’ØªÙØ¨ÙÙˆÙ‡Ù - O believers! When you contract a loan for a fixed period, put it in writing (2:282)",
    "Ø¥ÙÙ†ÙÙ‘ Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙŠÙØ£Ù’Ù…ÙØ±ÙÙƒÙÙ…Ù’ Ø£ÙÙ† ØªÙØ¤ÙØ¯ÙÙ‘ÙˆØ§ Ø§Ù„Ù’Ø£ÙÙ…ÙØ§Ù†ÙØ§ØªÙ Ø¥ÙÙ„ÙÙ‰Ù° Ø£ÙÙ‡Ù’Ù„ÙÙ‡ÙØ§ - Allah commands you to return trusts to their rightful owners (4:58)"
];

// Database
let users = {};
let products = [];
let categories = ['books', 'clothing', 'electronics', 'home', 'islamic', 'other'];

// Islamic Marketplace Engine
class HalalMarketplace {
    static verseOfTheDay() {
        return quranicVerses[Math.floor(Math.random() * quranicVerses.length)];
    }

    static calculateZakat(amount) {
        return (amount * 0.025).toFixed(2);
    }

    static isHalal(product) {
        const haram = ['alcohol', 'pork', 'haram', 'riba', 'interest', 'gambling', 'casino'];
        const text = (product.title + ' ' + product.description).toLowerCase();
        return !haram.some(word => text.includes(word));
    }
}

// ==================== BOT COMMANDS ====================

bot.start((ctx) => {
    const user = ctx.from;
    users[user.id] = {
        name: user.first_name,
        username: user.username,
        joined: new Date(),
        trust: 5.0,
        products: 0
    };

    ctx.reply(`
ğŸ•Œ *Welcome to Souk Al-Rahma!*

*Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù*

Assalamu Alaikum *${user.first_name}*!

ğŸ“– *Quranic Guidance:*
${HalalMarketplace.verseOfTheDay()}

*ğŸ›ï¸ Available Commands:*
/products - Browse halal products
/sell - List your product  
/categories - View categories
/zakat [amount] - Calculate Zakat
/profile - Your profile
/help - Islamic guidelines

*ğŸ’« Trade with honesty and fear Allah*
    `.trim(), { parse_mode: 'Markdown' });
});

bot.command('help', (ctx) => {
    ctx.reply(`
*ğŸ¤² Islamic Trading Guidelines*

*Quranic Principles:*
â€¢ Be truthful in business
â€¢ Honor your contracts
â€¢ Give full measure
â€¢ Avoid fraud and deception

*Hadith Reminder:*
"The truthful and honest merchant will be with the prophets, the truthful, and the martyrs." (Tirmidhi)

*Commands:*
/products - Browse items
/sell - List products
/zakat 1000 - Calculate Zakat
    `.trim(), { parse_mode: 'Markdown' });
});

bot.command('products', (ctx) => {
    if (products.length === 0) {
        return ctx.reply('ğŸ“¦ *No products yet!*\nBe the first to /sell', { parse_mode: 'Markdown' });
    }

    let message = `ğŸ“¦ *Halal Products (${products.length})*\n\n`;
    products.forEach((p, i) => {
        message += `*${i+1}. ${p.title}*\nğŸ’° $${p.price} | ğŸ“ ${p.category}\nğŸ‘¤ ${p.seller} | ğŸ“ ${p.description}\n\n`;
    });

    ctx.reply(message, { parse_mode: 'Markdown' });
});

bot.command('categories', (ctx) => {
    let message = `ğŸ“ *Product Categories*\n\n`;
    categories.forEach(cat => {
        const count = products.filter(p => p.category === cat).length;
        message += `â€¢ ${cat.charAt(0).toUpperCase() + cat.slice(1)} (${count} items)\n`;
    });
    message += `\nUse: /products_<category> to browse`;
    ctx.reply(message, { parse_mode: 'Markdown' });
});

// Category commands
categories.forEach(cat => {
    bot.command(`products_${cat}`, (ctx) => {
        const categoryProducts = products.filter(p => p.category === cat);
        if (categoryProducts.length === 0) {
            return ctx.reply(`ğŸ“¦ No products in *${cat}* category!\nUse /sell to list first.`, { parse_mode: 'Markdown' });
        }

        let message = `ğŸ“¦ *${cat.toUpperCase()} Products (${categoryProducts.length})*\n\n`;
        categoryProducts.forEach((p, i) => {
            message += `*${i+1}. ${p.title}*\nğŸ’° $${p.price} | ğŸ‘¤ ${p.seller}\nğŸ“ ${p.description}\n\n`;
        });

        ctx.reply(message, { parse_mode: 'Markdown' });
    });
});

bot.command('sell', (ctx) => {
    ctx.reply(`
ğŸ“¦ *List Your Product*

Send product details in this format:

*Product Title*
Price: $amount
Category: ${categories.join('/')}
Description: Halal details...

*Example:*
Islamic Prayer Rug
Price: $25
Category: islamic
Description: New, beautiful design for salah

*ğŸ•Œ Allah loves those who are honest in trade*
    `.trim(), { parse_mode: 'Markdown' });
});

bot.command('profile', (ctx) => {
    const user = users[ctx.from.id];
    if (!user) return ctx.reply('Please /start first');

    ctx.reply(`
ğŸ‘¤ *Your Profile*

*Name:* ${user.name}
*Username:* ${user.username || 'Not set'}
*Member Since:* ${user.joined.toLocaleDateString()}
*Trust Score:* â­ ${user.trust}/5.0
*Products Listed:* ${user.products}

*ğŸ’« Keep your trust high by:*
â€¢ Being honest
â€¢ Responding quickly
â€¢ Describing accurately
    `.trim(), { parse_mode: 'Markdown' });
});

bot.command('zakat', (ctx) => {
    const amount = ctx.message.text.split(' ')[1];
    if (!amount || isNaN(amount)) {
        return ctx.reply('ğŸ¤² *Usage:* /zakat <amount>\n*Example:* /zakat 1000', { parse_mode: 'Markdown' });
    }

    const zakat = HalalMarketplace.calculateZakat(parseFloat(amount));
    
    ctx.reply(`
ğŸ¤² *Zakat Calculation*

*Amount:* $${amount}
*Zakat (2.5%):* $${zakat}

*ğŸ“– Quran 9:103:*
"Take from their wealth charity to purify them."

*ğŸ’« Recommended Distribution:*
â€¢ Poor and needy Muslims
â€¢ Those in debt
â€¢ Islamic causes
â€¢ Stranded travelers

*Consult local scholars for precise calculation.*
    `.trim(), { parse_mode: 'Markdown' });
});

// Handle product creation
bot.on('text', (ctx) => {
    const text = ctx.message.text;
    const user = ctx.from;

    // Check if it's a product listing
    if (text.includes('Price: $') && text.includes('Category:') && text.includes('Description:')) {
        try {
            const lines = text.split('\n');
            const title = lines[0].trim();
            const price = lines[1].match(/\$(\d+)/)[1];
            const category = lines[2].split(':')[1].trim().toLowerCase();
            const description = lines[3].split(':')[1].trim();

            if (!categories.includes(category)) {
                return ctx.reply(`âŒ *Invalid category!* Use: ${categories.join(', ')}`, { parse_mode: 'Markdown' });
            }

            const product = {
                id: Date.now(),
                title,
                price: parseInt(price),
                category,
                description,
                seller: user.first_name,
                sellerId: user.id,
                timestamp: new Date()
            };

            if (!HalalMarketplace.isHalal(product)) {
                return ctx.reply('âŒ *Product rejected!* Contains haram elements.\nOnly halal items allowed.', { parse_mode: 'Markdown' });
            }

            products.push(product);
            users[user.id].products++;

            ctx.reply(`
âœ… *Product Listed Successfully!*

*Title:* ${product.title}
*Price:* $${product.price}
*Category:* ${product.category}
*Description:* ${product.description}

*ğŸ“Š Now visible in:*
/products - All products
/products_${category} - Category view
/categories - Category list

*ğŸ•Œ May Allah bring barakah!*
            `.trim(), { parse_mode: 'Markdown' });

        } catch (error) {
            ctx.reply('âŒ *Invalid format!* Use exact format from /sell', { parse_mode: 'Markdown' });
        }
    }
});

// Stats command
bot.command('stats', (ctx) => {
    const userCount = Object.keys(users).length;
    const productCount = products.length;
    
    ctx.reply(`
ğŸ“Š *Marketplace Stats*

*ğŸ‘¥ Total Users:* ${userCount}
*ğŸ“¦ Active Products:* ${productCount}
*ğŸ“ Categories:* ${categories.length}

*ğŸ•Œ Quranic Verse:*
${HalalMarketplace.verseOfTheDay()}

*ğŸ’« Growing by Allah's will*
    `.trim(), { parse_mode: 'Markdown' });
});

// Express server for web interface
app.get('/', (req, res) => {
    res.send(`
<!DOCTYPE html>
<html>
<head>
    <title>Ø³ÙˆÙ‚ Ø§Ù„Ø±Ø­Ù…Ø© - Souk Al-Rahma</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0d8b4e 0%, #0a6b3a 100%);
            margin: 0;
            padding: 20px;
            color: white;
            text-align: center;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        .header {
            margin-bottom: 30px;
        }
        .stats {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        .btn {
            display: block;
            background: #d4af37;
            color: white;
            padding: 15px;
            text-decoration: none;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª Souk Al-Rahma</h1>
            <p>Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</p>
            <p>Your Halal Marketplace is LIVE!</p>
        </div>
        
        <div class="stats">
            <h3>ğŸ“Š Live Statistics</h3>
            <p>ğŸ‘¥ Users: ${Object.keys(users).length}</p>
            <p>ğŸ“¦ Products: ${products.length}</p>
            <p>â­ 100% Halal</p>
        </div>
        
        <a href="https://t.me/${bot.context?.botInfo?.username}" class="btn">Open in Telegram</a>
        
        <div style="margin-top: 30px; opacity: 0.8;">
            <p>ğŸ•Œ Serving the Ummah with halal commerce</p>
            <p>Â© 2024 Souk Al-Rahma</p>
        </div>
    </div>
</body>
</html>
    `);
});

// Start everything
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`
ğŸ•Œ Souk Al-Rahma Server Running
ğŸ“ Port: ${PORT}
ğŸ“¿ Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù
    `.trim());
});

bot.launch().then(() => {
    console.log('ğŸ¤– Bot is LIVE! Serving the Ummah...');
}).catch(err => {
    console.error('âŒ Bot failed:', err.message);
});

// Graceful shutdown
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));

console.log('ğŸš€ Starting Souk Al-Rahma...');
