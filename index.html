<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroScan Matrix | Wellness Awareness</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [Keep all the CSS from previous code exactly the same] */
        /* ... All previous CSS code remains here ... */
    </style>
</head>
<body>
    <!-- [Keep all the HTML structure from previous code] -->
    <!-- ... All previous HTML code remains here ... -->

    <script>
        // DOM Elements (same as before)
        const matrixCanvas = document.getElementById('matrixCanvas');
        const videoElement = document.getElementById('videoElement');
        const startCameraBtn = document.getElementById('startCamera');
        const stopCameraBtn = document.getElementById('stopCamera');
        const scanFaceBtn = document.getElementById('scanFace');
        const cameraStatus = document.getElementById('cameraStatus');
        // ... other DOM elements ...

        // App State
        let appState = {
            cameraActive: false,
            scanCompleted: false,
            questionnaireCompleted: false,
            answers: {},
            scanResults: {},
            analysisInProgress: false,
            disclaimerAccepted: localStorage.getItem('neuroscan_disclaimer_accepted') === 'true',
            stream: null
        };

        // Matrix Rain Effect (same as before)
        function initMatrixRain() {
            // ... same matrix rain code ...
        }

        // Binary Stream Effect (same as before)
        function initBinaryStream() {
            // ... same binary stream code ...
        }

        // **UPDATED CAMERA FUNCTIONS WITH BETTER ERROR HANDLING**
        async function startCamera() {
            try {
                cameraStatus.innerHTML = `<i class="fas fa-sync fa-spin"></i> Accessing camera...`;
                
                // Check if we're on local file system
                if (window.location.protocol === 'file:') {
                    throw new Error("Cannot access camera from local file. Please use a local server.");
                }
                
                // Check camera permissions first
                if (navigator.permissions && navigator.permissions.query) {
                    const permission = await navigator.permissions.query({ name: 'camera' });
                    if (permission.state === 'denied') {
                        throw new Error("Camera permission denied. Please enable camera access in browser settings.");
                    }
                }
                
                // Get camera stream with specific constraints
                const constraints = {
                    video: {
                        facingMode: "user",
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                appState.stream = stream;
                videoElement.srcObject = stream;
                appState.cameraActive = true;
                
                // Update UI
                startCameraBtn.classList.add('btn-disabled');
                stopCameraBtn.classList.remove('btn-disabled');
                scanFaceBtn.classList.remove('btn-disabled');
                
                cameraStatus.innerHTML = `<i class="fas fa-check-circle" style="color:#00ff41"></i> Camera active. Position your face within the grid and click "Scan".`;
                
                // Handle when camera stops (e.g., user closes laptop lid)
                stream.getVideoTracks()[0].addEventListener('ended', () => {
                    stopCamera();
                    cameraStatus.innerHTML = `<i class="fas fa-exclamation-triangle" style="color:#ff9900"></i> Camera disconnected.`;
                });
                
            } catch(err) {
                console.error("Camera error:", err);
                
                // User-friendly error messages
                let errorMessage = err.message;
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMessage = "Camera permission denied. Please allow camera access in your browser settings.";
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    errorMessage = "No camera found. Please connect a camera and try again.";
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    errorMessage = "Camera is in use by another application. Please close other apps using the camera.";
                } else if (window.location.protocol === 'file:') {
                    errorMessage = "Cannot access camera from local file. Please: 1) Use a local server, or 2) Use the demo mode below.";
                }
                
                cameraStatus.innerHTML = `<i class="fas fa-exclamation-triangle" style="color:#ff9900"></i> ${errorMessage}`;
                
                // Show demo mode option
                showDemoModeOption();
            }
        }

        function stopCamera() {
            if (appState.stream) {
                appState.stream.getTracks().forEach(track => track.stop());
                appState.stream = null;
                videoElement.srcObject = null;
                appState.cameraActive = false;
                
                // Update UI
                startCameraBtn.classList.remove('btn-disabled');
                stopCameraBtn.classList.add('btn-disabled');
                scanFaceBtn.classList.add('btn-disabled');
                
                cameraStatus.innerHTML = `<i class="fas fa-info-circle"></i> Camera inactive. Click "Start Camera" to begin.`;
            }
        }

        // Show demo mode option when camera fails
        function showDemoModeOption() {
            const demoOption = document.createElement('div');
            demoOption.id = 'demoModeOption';
            demoOption.style.marginTop = '15px';
            demoOption.style.padding = '10px';
            demoOption.style.border = '1px dashed #00ff41';
            demoOption.style.borderRadius = '5px';
            demoOption.innerHTML = `
                <p style="margin-bottom: 10px;"><i class="fas fa-desktop"></i> <strong>Demo Mode Available</strong></p>
                <p style="margin-bottom: 10px; font-size: 0.9rem;">Since camera access isn't available, you can use demo data to test the app:</p>
                <button id="useDemoData" class="btn" style="width: 100%;">
                    <i class="fas fa-play-circle"></i> Use Demo Data
                </button>
            `;
            
            // Remove if already exists
            const existingDemo = document.getElementById('demoModeOption');
            if (existingDemo) existingDemo.remove();
            
            // Add after camera controls
            const cameraPanel = document.querySelector('.camera-controls').parentElement;
            cameraPanel.appendChild(demoOption);
            
            // Add event listener for demo button
            document.getElementById('useDemoData').addEventListener('click', useDemoData);
        }

        // Demo mode function
        function useDemoData() {
            appState.scanCompleted = true;
            appState.scanResults = {
                stressLevel: 65,
                anxietyIndicator: 58,
                overthinking: 72,
                facialTension: 45,
                heartRateVariability: 68
            };
            
            cameraStatus.innerHTML = `<i class="fas fa-check-circle" style="color:#00ff41"></i> Demo scan completed. ${appState.questionnaireCompleted ? 'Both scans complete. Results ready.' : 'Complete questionnaire for full analysis.'}`;
            
            // Remove demo option
            const demoOption = document.getElementById('demoModeOption');
            if (demoOption) demoOption.remove();
            
            if (appState.questionnaireCompleted) {
                generateResults();
            }
        }

        // Simulate face scanning (updated)
        function scanFace() {
            if (!appState.cameraActive && !appState.scanCompleted) {
                cameraStatus.innerHTML = `<i class="fas fa-exclamation-triangle" style="color:#ff9900"></i> Please start camera first or use demo mode.`;
                return;
            }
            
            // Show analysis screen
            analysisScreen.style.display = "block";
            mainApp.style.display = "none";
            appState.analysisInProgress = true;
            
            // Update analysis status messages
            const statusMessages = [
                "Analyzing facial micro-expressions...",
                "Measuring pupil dilation and blink rate...",
                "Detecting stress markers in facial muscle tension...",
                "Processing heart rate variability from facial blood flow...",
                "Cross-referencing with behavioral databases...",
                "Generating wellness profile..."
            ];
            
            let statusIndex = 0;
            const statusInterval = setInterval(() => {
                if (statusIndex < statusMessages.length) {
                    analysisStatus.textContent = statusMessages[statusIndex];
                    statusIndex++;
                } else {
                    clearInterval(statusInterval);
                    
                    // Generate simulated scan results (based on camera or demo)
                    if (appState.cameraActive) {
                        // Simulate based on "camera" being active
                        appState.scanResults = {
                            stressLevel: Math.floor(Math.random() * 30) + 40,
                            anxietyIndicator: Math.floor(Math.random() * 40) + 30,
                            overthinking: Math.floor(Math.random() * 35) + 35,
                            facialTension: Math.floor(Math.random() * 50) + 20,
                            heartRateVariability: Math.floor(Math.random() * 40) + 60
                        };
                    }
                    
                    // Complete analysis
                    setTimeout(() => {
                        analysisScreen.style.display = "none";
                        mainApp.style.display = "grid";
                        appState.scanCompleted = true;
                        cameraStatus.innerHTML = `<i class="fas fa-check-circle" style="color:#00ff41"></i> ${appState.cameraActive ? 'Biometric' : 'Demo'} scan completed. ${appState.questionnaireCompleted ? 'Both scans complete. Results ready.' : 'Complete questionnaire for full analysis.'}`;
                        
                        if (appState.questionnaireCompleted) {
                            generateResults();
                        }
                    }, 1500);
                }
            }, 1500);
        }

        // [Keep all other functions exactly the same as before]
        // initQuestionnaire, resetQuestionnaire, calculateQuestionnaireResults, 
        // generateResults, generateRecommendations, showResources, newAssessment
        
        // Event Listeners
        startCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn.addEventListener('click', stopCamera);
        scanFaceBtn.addEventListener('click', scanFace);
        
        // [Keep all other event listeners]

        // Initialize the app
        window.addEventListener('DOMContentLoaded', () => {
            initMatrixRain();
            initBinaryStream();
            initQuestionnaire();
            
            // Check for camera support
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                cameraStatus.innerHTML = `<i class="fas fa-exclamation-triangle" style="color:#ff3300"></i> Camera API not supported in this browser.`;
                startCameraBtn.classList.add('btn-disabled');
                
                // Show demo mode
                setTimeout(() => showDemoModeOption(), 1000);
            }
            
            // Check if running from local file
            if (window.location.protocol === 'file:') {
                setTimeout(() => {
                    cameraStatus.innerHTML = `<i class="fas fa-exclamation-triangle" style="color:#ff9900"></i> Running from local file. Camera requires HTTPS or localhost.`;
                    showDemoModeOption();
                }, 1000);
            }
        });
    </script>
</body>
</html>
