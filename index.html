# bot.py - Python backend for Telegram bot
import os
import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, CallbackContext
import json
from datetime import datetime

# Enable logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

class SecurityBot:
    def __init__(self, token):
        self.application = Application.builder().token(token).build()
        self.setup_handlers()
        
    def setup_handlers(self):
        self.application.add_handler(CommandHandler("start", self.start))
        self.application.add_handler(CommandHandler("security", self.security))
        self.application.add_handler(CommandHandler("status", self.status))
        
    async def start(self, update: Update, context: CallbackContext):
        """Send welcome message with mini app button"""
        user = update.effective_user
        welcome_text = f"""
ğŸ›¡ï¸ Welcome to Cyber Sentinel, {user.first_name}!

I'm your security monitoring assistant. Use the buttons below to:

ğŸ” Run security scans
ğŸ“ Track device location
ğŸš¨ Get intrusion alerts
ğŸ“Š Check security status

Click the button below to open the Security Monitor:
        """
        
        # Create keyboard with mini app button
        keyboard = [
            [{
                "text": "Open Security Monitor",
                "web_app": {"url": "https://yourdomain.com/security-app.html"}
            }]
        ]
        
        await update.message.reply_text(
            welcome_text,
            reply_markup={
                "inline_keyboard": keyboard
            }
        )
    
    async def security(self, update: Update, context: CallbackContext):
        """Security status command"""
        status_text = """
ğŸ”’ Security Status: ACTIVE

ğŸ“± Monitored Devices:
â€¢ Mobile Phone: âœ… Online
â€¢ Laptop: âœ… Secure
â€¢ Tablet: âš ï¸ No recent data

ğŸš¨ Recent Alerts: None
ğŸ“ Last Location: Home Network
        """
        
        await update.message.reply_text(status_text)
    
    async def status(self, update: Update, context: CallbackContext):
        """Quick status check"""
        await update.message.reply_text("ğŸŸ¢ All systems operational")
    
    def handle_webapp_data(self, data):
        """Process data from mini app"""
        try:
            data_dict = json.loads(data)
            action = data_dict.get('action')
            user_id = data_dict.get('user_id')
            
            if action == 'intrusion_alert':
                self.send_alert_to_user(user_id, "ğŸš¨ SECURITY ALERT: Intrusion detected!")
            elif action == 'location_update':
                self.log_location(user_id, data_dict)
            elif action == 'test_notification':
                self.log_test(user_id)
                
            logging.info(f"Processed {action} from user {user_id}")
            
        except Exception as e:
            logging.error(f"Error processing webapp data: {e}")
    
    def send_alert_to_user(self, user_id, message):
        """Send security alert to user"""
        # This would actually send a message to the user
        logging.info(f"Alert for {user_id}: {message}")
    
    def log_location(self, user_id, data):
        """Log user location"""
        logging.info(f"Location update from {user_id}: {data}")
    
    def log_test(self, user_id):
        """Log test event"""
        logging.info(f"Test from user {user_id}")

# Usage
if __name__ == '__main__':
    BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"
    bot = SecurityBot(BOT_TOKEN)
    bot.application.run_polling()
    
