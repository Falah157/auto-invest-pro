<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRC Assistant Manager - Construction Site Management</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #00a8ff;
            --secondary: #0097e6;
            --accent: #00d2d3;
            --danger: #e84118;
            --warning: #fbc531;
            --success: #4cd137;
            --bg-dark: #0c2461;
            --card-bg: #1e3799;
            --text-light: #dfe6e9;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 2px solid var(--primary);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--warning));
            animation: pulse 3s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        .logo {
            font-size: 2em;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .tagline {
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #34495e;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            margin: 5px 0;
        }

        .stat-label {
            color: #aaa;
            font-size: 0.8em;
        }

        .primary { color: var(--primary); }
        .accent { color: var(--accent); }
        .warning { color: var(--warning); }
        .success { color: var(--success); }
        .danger { color: var(--danger); }

        /* Mobile Tabs */
        .mobile-tabs {
            display: flex;
            margin-bottom: 15px;
            background: var(--card-bg);
            border-radius: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 5px;
        }

        .mobile-tab {
            padding: 12px 15px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 8px;
            margin: 0 2px;
            flex: 1;
            text-align: center;
            font-size: 0.85em;
        }

        .mobile-tab.active {
            background: rgba(0, 168, 255, 0.2);
            border: 1px solid var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #34495e;
            margin-bottom: 15px;
        }

        .card h3 {
            color: var(--primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #34495e;
            padding-bottom: 8px;
            font-size: 1.1em;
        }

        /* Forms */
        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-size: 0.9em;
        }

        input, select, button, textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #34495e;
            background: #2c3e50;
            color: white;
            font-size: 1em;
        }

        button {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 5px;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-success {
            background: linear-gradient(90deg, var(--success), #27ae60);
        }

        .btn-warning {
            background: linear-gradient(90deg, var(--warning), #e1b12c);
        }

        .btn-danger {
            background: linear-gradient(90deg, var(--danger), #c23616);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.85em;
            width: auto;
        }

        /* Map */
        #map {
            height: 300px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #34495e;
        }

        /* Reports List */
        .report-item, .issue-item {
            background: #2c3e50;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
        }

        .issue-item {
            border-left-color: var(--warning);
        }

        .report-header, .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .report-id, .issue-id {
            font-weight: bold;
            color: var(--primary);
        }

        .report-date, .issue-date {
            color: #aaa;
            font-size: 0.8em;
        }

        .report-progress {
            display: inline-block;
            padding: 2px 8px;
            background: var(--primary);
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 8px;
        }

        .issue-priority {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 8px;
        }

        .priority-high { background: var(--danger); }
        .priority-medium { background: var(--warning); }
        .priority-low { background: var(--success); }

        /* Status Messages */
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-size: 0.9em;
        }

        .status.success {
            background: rgba(76, 209, 55, 0.2);
            border: 1px solid var(--success);
        }

        .status.info {
            background: rgba(0, 168, 255, 0.2);
            border: 1px solid var(--primary);
        }

        .status.warning {
            background: rgba(251, 197, 49, 0.2);
            border: 1px solid var(--warning);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            display: flex;
            padding: 10px;
            border-top: 2px solid var(--primary);
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px 5px;
            color: #aaa;
            font-size: 0.75em;
            transition: all 0.3s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 1.4em;
            margin-bottom: 3px;
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        /* Photo Preview */
        .photo-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid var(--primary);
        }

        /* Location Button */
        .location-btn {
            background: linear-gradient(90deg, var(--accent), #00b894);
        }

        /* Responsive */
        @media (max-width: 380px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .mobile-tab {
                padding: 10px 12px;
                font-size: 0.8em;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">MRC ASSISTANT MANAGER</div>
            <p class="tagline">Construction Site Management System</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                <button class="btn-warning btn-small" onclick="syncData()">
                    <i class="fas fa-sync-alt"></i> Sync Data
                </button>
                <button class="btn-danger btn-small" onclick="clearAllData()">
                    <i class="fas fa-trash"></i> Clear Data
                </button>
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Active Reports</div>
                <div class="stat-value primary" id="activeReports">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Open Issues</div>
                <div class="stat-value warning" id="openIssues">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Today's Check-ins</div>
                <div class="stat-value accent" id="todayCheckins">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Team Members</div>
                <div class="stat-value success" id="teamMembers">0</div>
            </div>
        </div>

        <!-- Mobile Tabs -->
        <div class="mobile-tabs">
            <div class="mobile-tab active" onclick="switchTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i><br>Dashboard
            </div>
            <div class="mobile-tab" onclick="switchTab('reports')">
                <i class="fas fa-clipboard-list"></i><br>Reports
            </div>
            <div class="mobile-tab" onclick="switchTab('issues')">
                <i class="fas fa-exclamation-triangle"></i><br>Issues
            </div>
            <div class="mobile-tab" onclick="switchTab('attendance')">
                <i class="fas fa-user-check"></i><br>Attendance
            </div>
            <div class="mobile-tab" onclick="switchTab('map')">
                <i class="fas fa-map-marked-alt"></i><br>Live Map
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="card">
                <h3><i class="fas fa-map-marker-alt"></i> Site Overview Map</h3>
                <div id="map"></div>
                <div class="action-buttons">
                    <button class="btn-success" onclick="getCurrentLocation()">
                        <i class="fas fa-location-arrow"></i> My Location
                    </button>
                    <button class="location-btn" onclick="showAllLocations()">
                        <i class="fas fa-layer-group"></i> Show All Sites
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-bell"></i> Recent Activity</h3>
                <div id="recentActivity">
                    <div class="status info">No recent activity</div>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-tasks"></i> Quick Actions</h3>
                <div class="action-buttons">
                    <button class="btn-success" onclick="switchTab('reports'); startNewReport();">
                        <i class="fas fa-plus"></i> New Report
                    </button>
                    <button class="btn-warning" onclick="switchTab('issues'); startNewIssue();">
                        <i class="fas fa-exclamation-circle"></i> Report Issue
                    </button>
                    <button class="location-btn" onclick="checkIn()">
                        <i class="fas fa-sign-in-alt"></i> Check In
                    </button>
                    <button class="btn-danger" onclick="checkOut()">
                        <i class="fas fa-sign-out-alt"></i> Check Out
                    </button>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-plus-circle"></i> Create New Report</h3>
                <div class="form-group">
                    <label for="reportLocation">Location</label>
                    <div class="action-buttons">
                        <button class="location-btn" onclick="getReportLocation()">
                            <i class="fas fa-map-marker-alt"></i> Use Current Location
                        </button>
                        <button class="btn-small" onclick="useManualLocation('report')">
                            <i class="fas fa-edit"></i> Enter Manually
                        </button>
                    </div>
                    <input type="text" id="reportLocation" placeholder="Location description">
                </div>
                
                <div class="form-group">
                    <label for="reportProgress">Progress (%)</label>
                    <input type="number" id="reportProgress" min="0" max="100" value="0">
                </div>
                
                <div class="form-group">
                    <label for="reportMaterials">Materials Used</label>
                    <input type="text" id="reportMaterials" placeholder="e.g., Concrete, Steel, Gravel">
                </div>
                
                <div class="form-group">
                    <label for="reportMachines">Machines Used</label>
                    <input type="text" id="reportMachines" placeholder="e.g., Excavator, Crane, Mixer">
                </div>
                
                <div class="form-group">
                    <label for="reportNotes">Notes</label>
                    <textarea id="reportNotes" rows="3" placeholder="Additional details about the work..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Photo (Optional)</label>
                    <input type="file" id="reportPhoto" accept="image/*" onchange="previewReportPhoto()">
                    <img id="reportPhotoPreview" class="photo-preview" style="display: none;">
                </div>
                
                <button class="btn-success" onclick="saveReport()">
                    <i class="fas fa-save"></i> Save Report
                </button>
            </div>

            <div class="card">
                <h3><i class="fas fa-clipboard-list"></i> Recent Reports</h3>
                <div id="reportsList">
                    <div class="status info">No reports yet</div>
                </div>
            </div>
        </div>

        <!-- Issues Tab -->
        <div id="issues" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-exclamation-triangle"></i> Report New Issue</h3>
                <div class="form-group">
                    <label for="issueTitle">Issue Title</label>
                    <input type="text" id="issueTitle" placeholder="Brief description of the issue">
                </div>
                
                <div class="form-group">
                    <label for="issueLocation">Location</label>
                    <div class="action-buttons">
                        <button class="location-btn" onclick="getIssueLocation()">
                            <i class="fas fa-map-marker-alt"></i> Use Current Location
                        </button>
                        <button class="btn-small" onclick="useManualLocation('issue')">
                            <i class="fas fa-edit"></i> Enter Manually
                        </button>
                    </div>
                    <input type="text" id="issueLocation" placeholder="Location description">
                </div>
                
                <div class="form-group">
                    <label for="issuePriority">Priority</label>
                    <select id="issuePriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="issueDescription">Description</label>
                    <textarea id="issueDescription" rows="3" placeholder="Detailed description of the issue..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Photo (Optional)</label>
                    <input type="file" id="issuePhoto" accept="image/*" onchange="previewIssuePhoto()">
                    <img id="issuePhotoPreview" class="photo-preview" style="display: none;">
                </div>
                
                <button class="btn-warning" onclick="saveIssue()">
                    <i class="fas fa-save"></i> Save Issue
                </button>
            </div>

            <div class="card">
                <h3><i class="fas fa-list"></i> Active Issues</h3>
                <div id="issuesList">
                    <div class="status info">No active issues</div>
                </div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-user-check"></i> Team Attendance</h3>
                <div class="action-buttons">
                    <button class="btn-success" onclick="checkIn()">
                        <i class="fas fa-sign-in-alt"></i> Check In
                    </button>
                    <button class="btn-danger" onclick="checkOut()">
                        <i class="fas fa-sign-out-alt"></i> Check Out
                    </button>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-history"></i> Today's Attendance</h3>
                <div id="attendanceList">
                    <div class="status info">No attendance records today</div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-users"></i> Team Members</h3>
                <div id="teamList">
                    <div class="status info">No team members added</div>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label for="newMemberName">Add Team Member</label>
                    <input type="text" id="newMemberName" placeholder="Full name">
                    <input type="text" id="newMemberRole" placeholder="Role" style="margin-top: 8px;">
                    <button class="btn-small" onclick="addTeamMember()" style="margin-top: 8px;">
                        <i class="fas fa-user-plus"></i> Add Member
                    </button>
                </div>
            </div>
        </div>

        <!-- Map Tab -->
        <div id="mapTab" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-map-marked-alt"></i> Live Site Map</h3>
                <div id="detailedMap" style="height: 400px;"></div>
                <div class="action-buttons">
                    <button class="location-btn" onclick="refreshMap()">
                        <i class="fas fa-sync-alt"></i> Refresh Map
                    </button>
                    <button class="btn-success" onclick="getCurrentLocationForMap()">
                        <i class="fas fa-location-arrow"></i> My Location
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-layer-group"></i> Map Legend</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: var(--primary); border-radius: 50%;"></div>
                        <span>Reports</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: var(--warning); border-radius: 50%;"></div>
                        <span>Issues</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: var(--success); border-radius: 50%;"></div>
                        <span>Check-ins</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: var(--accent); border-radius: 50%;"></div>
                        <span>Team Locations</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('dashboard')">
            <div class="nav-icon"><i class="fas fa-tachometer-alt"></i></div>
            <div>Dashboard</div>
        </div>
        <div class="nav-item" onclick="switchTab('reports')">
            <div class="nav-icon"><i class="fas fa-clipboard-list"></i></div>
            <div>Reports</div>
        </div>
        <div class="nav-item" onclick="switchTab('issues')">
            <div class="nav-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div>Issues</div>
        </div>
        <div class="nav-item" onclick="switchTab('attendance')">
            <div class="nav-icon"><i class="fas fa-user-check"></i></div>
            <div>Attendance</div>
        </div>
        <div class="nav-item" onclick="switchTab('map')">
            <div class="nav-icon"><i class="fas fa-map-marked-alt"></i></div>
            <div>Map</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Data storage
        let reports = JSON.parse(localStorage.getItem('mrc_reports')) || [];
        let issues = JSON.parse(localStorage.getItem('mrc_issues')) || [];
        let attendance = JSON.parse(localStorage.getItem('mrc_attendance')) || [];
        let teamMembers = JSON.parse(localStorage.getItem('mrc_team')) || [
            { id: 1, name: 'Site Manager', role: 'Manager', active: true },
            { id: 2, name: 'Foreman', role: 'Supervisor', active: true }
        ];
        
        let map, detailedMap;
        let currentLocation = { latitude: 4.1755, longitude: 73.5093 }; // Default sample location

        // Initialize the app
        function initApp() {
            updateDashboard();
            initMap();
            initDetailedMap();
            updateReportsList();
            updateIssuesList();
            updateAttendanceList();
            updateTeamList();
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.mobile-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            if (tabName === 'map') {
                document.getElementById('mapTab').classList.add('active');
                setTimeout(() => {
                    if (detailedMap) detailedMap.invalidateSize();
                }, 100);
            } else {
                document.getElementById(tabName).classList.add('active');
            }
            
            // Add active class to clicked tab
            const clickedTab = event.currentTarget;
            clickedTab.classList.add('active');
            
            // Find and activate corresponding bottom nav item
            const navItems = document.querySelectorAll('.nav-item');
            const tabIndex = Array.from(document.querySelectorAll('.mobile-tab')).indexOf(clickedTab);
            if (tabIndex >= 0 && navItems[tabIndex]) {
                navItems[tabIndex].classList.add('active');
            }
        }

        // Initialize main map
        function initMap() {
            map = L.map('map').setView([currentLocation.latitude, currentLocation.longitude], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ''
            }).addTo(map);
            
            // Add sample marker
            L.marker([currentLocation.latitude, currentLocation.longitude]).addTo(map)
                .bindPopup('Main Construction Site<br>Start adding reports and issues!')
                .openPopup();
            
            updateMap();
        }

        // Initialize detailed map
        function initDetailedMap() {
            detailedMap = L.map('detailedMap').setView([currentLocation.latitude, currentLocation.longitude], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ''
            }).addTo(detailedMap);
            
            updateDetailedMap();
        }

        // Update maps with data
        function updateMap() {
            // Clear existing markers (except base layers)
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                    map.removeLayer(layer);
                }
            });

            // Add main site marker
            L.marker([currentLocation.latitude, currentLocation.longitude]).addTo(map)
                .bindPopup('Main Construction Site');

            // Add reports
            reports.forEach(report => {
                const lat = report.latitude || currentLocation.latitude + (Math.random() - 0.5) * 0.01;
                const lng = report.longitude || currentLocation.longitude + (Math.random() - 0.5) * 0.01;
                
                L.circleMarker([lat, lng], {
                    radius: 8,
                    color: '#00a8ff',
                    fillColor: '#00a8ff',
                    fillOpacity: 0.7
                }).addTo(map).bindPopup(`
                    <b>Report #${report.id}</b><br>
                    Progress: ${report.progress}%<br>
                    ${report.notes || ''}
                `);
            });

            // Add issues
            issues.forEach(issue => {
                const lat = issue.latitude || currentLocation.latitude + (Math.random() - 0.5) * 0.01;
                const lng = issue.longitude || currentLocation.longitude + (Math.random() - 0.5) * 0.01;
                
                L.circleMarker([lat, lng], {
                    radius: 8,
                    color: '#fbc531',
                    fillColor: '#fbc531',
                    fillOpacity: 0.7
                }).addTo(map).bindPopup(`
                    <b>Issue #${issue.id}</b><br>
                    ${issue.title}<br>
                    Priority: ${issue.priority}
                `);
            });
        }

        function updateDetailedMap() {
            if (!detailedMap) return;
            
            // Clear existing markers
            detailedMap.eachLayer((layer) => {
                if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                    detailedMap.removeLayer(layer);
                }
            });

            // Add all markers to detailed map
            let bounds = [];

            // Main site
            const mainMarker = L.marker([currentLocation.latitude, currentLocation.longitude]).addTo(detailedMap)
                .bindPopup('<b>Main Construction Site</b>');
            bounds.push([currentLocation.latitude, currentLocation.longitude]);

            // Reports
            reports.forEach(report => {
                const lat = report.latitude || currentLocation.latitude + (Math.random() - 0.5) * 0.01;
                const lng = report.longitude || currentLocation.longitude + (Math.random() - 0.5) * 0.01;
                
                const marker = L.circleMarker([lat, lng], {
                    radius: 10,
                    color: '#00a8ff',
                    fillColor: '#00a8ff',
                    fillOpacity: 0.8
                }).addTo(detailedMap).bindPopup(`
                    <b>Report #${report.id}</b><br>
                    Progress: ${report.progress}%<br>
                    Materials: ${report.materials || 'N/A'}<br>
                    ${report.notes || ''}
                `);
                bounds.push([lat, lng]);
            });

            // Issues
            issues.forEach(issue => {
                const lat = issue.latitude || currentLocation.latitude + (Math.random() - 0.5) * 0.01;
                const lng = issue.longitude || currentLocation.longitude + (Math.random() - 0.5) * 0.01;
                
                const marker = L.circleMarker([lat, lng], {
                    radius: 10,
                    color: '#fbc531',
                    fillColor: '#fbc531',
                    fillOpacity: 0.8
                }).addTo(detailedMap).bindPopup(`
                    <b>Issue #${issue.id}</b><br>
                    ${issue.title}<br>
                    Priority: ${issue.priority}<br>
                    ${issue.description || ''}
                `);
                bounds.push([lat, lng]);
            });

            // Attendance
            attendance.forEach(record => {
                const lat = record.latitude || currentLocation.latitude + (Math.random() - 0.5) * 0.005;
                const lng = record.longitude || currentLocation.longitude + (Math.random() - 0.5) * 0.005;
                
                const color = record.action === 'checkin' ? '#4cd137' : '#e84118';
                const marker = L.circleMarker([lat, lng], {
                    radius: 6,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.8
                }).addTo(detailedMap).bindPopup(`
                    <b>${record.action.toUpperCase()}</b><br>
                    ${record.username || 'User'}<br>
                    ${new Date(record.timestamp).toLocaleString()}
                `);
                bounds.push([lat, lng]);
            });

            // Fit map to show all markers
            if (bounds.length > 0) {
                detailedMap.fitBounds(bounds);
            }
        }

        // Location functions with fallback
        function getCurrentLocation() {
            if (navigator.geolocation) {
                showStatus('Getting your location...', 'info');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        map.setView([currentLocation.latitude, currentLocation.longitude], 15);
                        L.marker([currentLocation.latitude, currentLocation.longitude])
                            .addTo(map)
                            .bindPopup('Your current location')
                            .openPopup();
                        showStatus('Location found! Map updated.', 'success');
                    },
                    (error) => {
                        showStatus('Using sample location. Enable location permissions for accurate tracking.', 'warning');
                        // Keep using sample location
                        map.setView([currentLocation.latitude, currentLocation.longitude], 15);
                    },
                    { 
                        timeout: 10000,
                        enableHighAccuracy: false 
                    }
                );
            } else {
                showStatus('Geolocation not supported. Using sample location.', 'warning');
            }
        }

        function getCurrentLocationForMap() {
            if (navigator.geolocation) {
                showStatus('Getting your location...', 'info');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        detailedMap.setView([currentLocation.latitude, currentLocation.longitude], 15);
                        L.marker([currentLocation.latitude, currentLocation.longitude])
                            .addTo(detailedMap)
                            .bindPopup('Your current location')
                            .openPopup();
                        showStatus('Location found!', 'success');
                    },
                    (error) => {
                        showStatus('Using sample location.', 'warning');
                        detailedMap.setView([currentLocation.latitude, currentLocation.longitude], 15);
                    },
                    { timeout: 10000 }
                );
            } else {
                showStatus('Geolocation not supported.', 'warning');
            }
        }

        function getReportLocation() {
            if (navigator.geolocation) {
                showStatus('Getting location for report...', 'info');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        document.getElementById('reportLocation').value = 
                            `Lat: ${position.coords.latitude.toFixed(6)}, Lng: ${position.coords.longitude.toFixed(6)}`;
                        showStatus('Report location set!', 'success');
                    },
                    (error) => {
                        useManualLocation('report');
                    },
                    { timeout: 10000 }
                );
            } else {
                useManualLocation('report');
            }
        }

        function getIssueLocation() {
            if (navigator.geolocation) {
                showStatus('Getting location for issue...', 'info');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        document.getElementById('issueLocation').value = 
                            `Lat: ${position.coords.latitude.toFixed(6)}, Lng: ${position.coords.longitude.toFixed(6)}`;
                        showStatus('Issue location set!', 'success');
                    },
                    (error) => {
                        useManualLocation('issue');
                    },
                    { timeout: 10000 }
                );
            } else {
                useManualLocation('issue');
            }
        }

        function useManualLocation(type) {
            const defaultLocation = "Construction Site - Main Area";
            const manualLocation = prompt('Enter location manually:', defaultLocation);
            if (manualLocation) {
                if (type === 'report') {
                    document.getElementById('reportLocation').value = manualLocation;
                } else {
                    document.getElementById('issueLocation').value = manualLocation;
                }
                showStatus('Manual location set!', 'success');
            }
        }

        function showAllLocations() {
            updateMap();
            updateDetailedMap();
            showStatus('Showing all site locations', 'info');
        }

        function refreshMap() {
            updateDetailedMap();
            showStatus('Map refreshed', 'info');
        }

        // Report functions
        function startNewReport() {
            document.getElementById('reportLocation').value = '';
            document.getElementById('reportProgress').value = '0';
            document.getElementById('reportMaterials').value = '';
            document.getElementById('reportMachines').value = '';
            document.getElementById('reportNotes').value = '';
            document.getElementById('reportPhoto').value = '';
            document.getElementById('reportPhotoPreview').style.display = 'none';
        }

        function previewReportPhoto() {
            const file = document.getElementById('reportPhoto').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('reportPhotoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function saveReport() {
            const location = document.getElementById('reportLocation').value;
            const progress = parseInt(document.getElementById('reportProgress').value) || 0;
            const materials = document.getElementById('reportMaterials').value;
            const machines = document.getElementById('reportMachines').value;
            const notes = document.getElementById('reportNotes').value;

            if (!location) {
                showStatus('Please set a location for the report', 'warning');
                return;
            }

            const newReport = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                location: location,
                progress: progress,
                materials: materials,
                machines: machines,
                notes: notes,
                latitude: currentLocation.latitude,
                longitude: currentLocation.longitude,
                photo: document.getElementById('reportPhotoPreview').src || null
            };

            reports.unshift(newReport);
            localStorage.setItem('mrc_reports', JSON.stringify(reports));
            
            updateDashboard();
            updateReportsList();
            updateMap();
            updateDetailedMap();
            
            showStatus('Report saved successfully!', 'success');
            startNewReport();
        }

        function updateReportsList() {
            const container = document.getElementById('reportsList');
            if (reports.length === 0) {
                container.innerHTML = '<div class="status info">No reports yet</div>';
                return;
            }

            container.innerHTML = reports.slice(0, 10).map(report => `
                <div class="report-item">
                    <div class="report-header">
                        <div class="report-id">Report #${report.id}</div>
                        <div class="report-date">${new Date(report.timestamp).toLocaleDateString()}</div>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span class="report-progress">${report.progress}%</span>
                        <span>${report.location}</span>
                    </div>
                    <div style="color: #ccc; font-size: 0.9em;">
                        ${report.notes || 'No additional notes'}
                    </div>
                    ${report.materials ? `<div style="margin-top: 4px; font-size: 0.8em; color: #aaa;">Materials: ${report.materials}</div>` : ''}
                    ${report.machines ? `<div style="font-size: 0.8em; color: #aaa;">Machines: ${report.machines}</div>` : ''}
                    ${report.photo ? `<div style="margin-top: 8px;"><img src="${report.photo}" style="max-width: 100%; border-radius: 4px;"></div>` : ''}
                </div>
            `).join('');
        }

        // Issue functions
        function startNewIssue() {
            document.getElementById('issueTitle').value = '';
            document.getElementById('issueLocation').value = '';
            document.getElementById('issuePriority').value = 'medium';
            document.getElementById('issueDescription').value = '';
            document.getElementById('issuePhoto').value = '';
            document.getElementById('issuePhotoPreview').style.display = 'none';
        }

        function previewIssuePhoto() {
            const file = document.getElementById('issuePhoto').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('issuePhotoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function saveIssue() {
            const title = document.getElementById('issueTitle').value;
            const location = document.getElementById('issueLocation').value;
            const priority = document.getElementById('issuePriority').value;
            const description = document.getElementById('issueDescription').value;

            if (!title || !location) {
                showStatus('Please fill in title and location', 'warning');
                return;
            }

            const newIssue = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                title: title,
                location: location,
                priority: priority,
                description: description,
                latitude: currentLocation.latitude,
                longitude: currentLocation.longitude,
                photo: document.getElementById('issuePhotoPreview').src || null,
                status: 'open'
            };

            issues.unshift(newIssue);
            localStorage.setItem('mrc_issues', JSON.stringify(issues));
            
            updateDashboard();
            updateIssuesList();
            updateMap();
            updateDetailedMap();
            
            showStatus('Issue reported successfully!', 'success');
            startNewIssue();
        }

        function updateIssuesList() {
            const container = document.getElementById('issuesList');
            const openIssues = issues.filter(issue => issue.status === 'open');
            
            if (openIssues.length === 0) {
                container.innerHTML = '<div class="status info">No active issues</div>';
                return;
            }

            container.innerHTML = openIssues.slice(0, 10).map(issue => `
                <div class="issue-item">
                    <div class="issue-header">
                        <div class="issue-id">Issue #${issue.id}</div>
                        <div class="issue-date">${new Date(issue.timestamp).toLocaleDateString()}</div>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span class="issue-priority priority-${issue.priority}">${issue.priority.toUpperCase()}</span>
                        <strong>${issue.title}</strong>
                    </div>
                    <div style="color: #ccc; font-size: 0.9em; margin-bottom: 8px;">
                        ${issue.description || 'No description'}
                    </div>
                    <div style="font-size: 0.8em; color: #aaa;">
                        Location: ${issue.location}
                    </div>
                    ${issue.photo ? `<div style="margin-top: 8px;"><img src="${issue.photo}" style="max-width: 100%; border-radius: 4px;"></div>` : ''}
                    <button class="btn-small btn-success" onclick="closeIssue(${issue.id})" style="margin-top: 8px;">
                        <i class="fas fa-check"></i> Mark Resolved
                    </button>
                </div>
            `).join('');
        }

        function closeIssue(issueId) {
            const issue = issues.find(i => i.id === issueId);
            if (issue) {
                issue.status = 'closed';
                localStorage.setItem('mrc_issues', JSON.stringify(issues));
                updateIssuesList();
                updateDashboard();
                showStatus('Issue marked as resolved', 'success');
            }
        }

        // Attendance functions
        function checkIn() {
            const record = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                action: 'checkin',
                latitude: currentLocation.latitude,
                longitude: currentLocation.longitude,
                username: 'User'
            };
            attendance.unshift(record);
            localStorage.setItem('mrc_attendance', JSON.stringify(attendance));
            updateAttendanceList();
            updateDashboard();
            showStatus('Checked in successfully!', 'success');
        }

        function checkOut() {
            const record = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                action: 'checkout',
                latitude: currentLocation.latitude,
                longitude: currentLocation.longitude,
                username: 'User'
            };
            attendance.unshift(record);
            localStorage.setItem('mrc_attendance', JSON.stringify(attendance));
            updateAttendanceList();
            updateDashboard();
            showStatus('Checked out successfully!', 'success');
        }

        function updateAttendanceList() {
            const container = document.getElementById('attendanceList');
            const today = new Date().toDateString();
            const todayRecords = attendance.filter(record => 
                new Date(record.timestamp).toDateString() === today
            );

            if (todayRecords.length === 0) {
                container.innerHTML = '<div class="status info">No attendance records today</div>';
                return;
            }

            container.innerHTML = todayRecords.map(record => `
                <div class="report-item" style="border-left-color: ${record.action === 'checkin' ? '#4cd137' : '#e84118'};">
                    <div class="report-header">
                        <div class="report-id">${record.action.toUpperCase()}</div>
                        <div class="report-date">${new Date(record.timestamp).toLocaleTimeString()}</div>
                    </div>
                    <div style="color: #ccc; font-size: 0.9em;">
                        ${record.username} - Location recorded
                    </div>
                </div>
            `).join('');
        }

        // Team functions
        function addTeamMember() {
            const name = document.getElementById('newMemberName').value;
            const role = document.getElementById('newMemberRole').value;

            if (!name) {
                showStatus('Please enter a name', 'warning');
                return;
            }

            const newMember = {
                id: Date.now(),
                name: name,
                role: role || 'Worker',
                active: true
            };

            teamMembers.push(newMember);
            localStorage.setItem('mrc_team', JSON.stringify(teamMembers));
            
            updateTeamList();
            updateDashboard();
            
            document.getElementById('newMemberName').value = '';
            document.getElementById('newMemberRole').value = '';
            showStatus('Team member added!', 'success');
        }

        function updateTeamList() {
            const container = document.getElementById('teamList');
            if (teamMembers.length === 0) {
                container.innerHTML = '<div class="status info">No team members added</div>';
                return;
            }

            container.innerHTML = teamMembers.map(member => `
                <div class="report-item">
                    <div class="report-header">
                        <div class="report-id">${member.name}</div>
                        <div style="font-size: 0.8em; color: ${member.active ? '#4cd137' : '#e84118'}">
                            ${member.active ? 'Active' : 'Inactive'}
                        </div>
                    </div>
                    <div style="color: #ccc; font-size: 0.9em;">
                        ${member.role}
                    </div>
                </div>
            `).join('');
        }

        // Dashboard update
        function updateDashboard() {
            const today = new Date().toDateString();
            const todayAttendance = attendance.filter(record => 
                new Date(record.timestamp).toDateString() === today
            );

            document.getElementById('activeReports').textContent = reports.length;
            document.getElementById('openIssues').textContent = issues.filter(i => i.status === 'open').length;
            document.getElementById('todayCheckins').textContent = todayAttendance.filter(a => a.action === 'checkin').length;
            document.getElementById('teamMembers').textContent = teamMembers.filter(m => m.active).length;

            // Update recent activity
            const activityContainer = document.getElementById('recentActivity');
            const allActivities = [
                ...reports.map(r => ({ type: 'report', ...r })),
                ...issues.map(i => ({ type: 'issue', ...i })),
                ...attendance.map(a => ({ type: 'attendance', ...a }))
            ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 5);

            if (allActivities.length === 0) {
                activityContainer.innerHTML = '<div class="status info">No recent activity</div>';
                return;
            }

            activityContainer.innerHTML = allActivities.map(activity => {
                let icon, color, text;
                if (activity.type === 'report') {
                    icon = 'clipboard-list';
                    color = '#00a8ff';
                    text = `New report: ${activity.progress}% progress`;
                } else if (activity.type === 'issue') {
                    icon = 'exclamation-triangle';
                    color = '#fbc531';
                    text = `New issue: ${activity.title}`;
                } else {
                    icon = activity.action === 'checkin' ? 'sign-in-alt' : 'sign-out-alt';
                    color = activity.action === 'checkin' ? '#4cd137' : '#e84118';
                    text = `${activity.action.toUpperCase()}: ${activity.username}`;
                }

                return `
                    <div class="report-item" style="border-left-color: ${color};">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-${icon}" style="color: ${color};"></i>
                            <div style="flex: 1;">
                                <div style="font-size: 0.9em;">${text}</div>
                                <div style="font-size: 0.8em; color: #aaa;">${new Date(activity.timestamp).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Utility functions
        function showStatus(message, type) {
            // Create temporary status message
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.textContent = message;
            status.style.position = 'fixed';
            status.style.top = '20px';
            status.style.left = '50%';
            status.style.transform = 'translateX(-50%)';
            status.style.zIndex = '1000';
            status.style.minWidth = '200px';
            status.style.textAlign = 'center';
            status.style.maxWidth = '90%';
            
            document.body.appendChild(status);
            
            setTimeout(() => {
                if (status.parentNode) {
                    status.parentNode.removeChild(status);
                }
            }, 3000);
        }

        function syncData() {
            showStatus('Data synced with local storage', 'info');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
                localStorage.removeItem('mrc_reports');
                localStorage.removeItem('mrc_issues');
                localStorage.removeItem('mrc_attendance');
                localStorage.removeItem('mrc_team');
                
                reports = [];
                issues = [];
                attendance = [];
                teamMembers = [
                    { id: 1, name: 'Site Manager', role: 'Manager', active: true },
                    { id: 2, name: 'Foreman', role: 'Supervisor', active: true }
                ];
                
                initApp();
                showStatus('All data cleared!', 'success');
            }
        }

        // Initialize the app when page loads
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
